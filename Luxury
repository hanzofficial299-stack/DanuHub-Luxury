--[[
    DanuHub_NEW - Fisch Script (FULL VERSION - FIXED)
    Version: 2.1.0 - Complete Features Fixed
    All features from original script + Fixes
]]

print("[DanuHub] Script starting...")

-- Services
local Services = {
    Players = game:GetService("Players"),
    RunService = game:GetService("RunService"),
    HttpService = game:GetService("HttpService"),
    RS = game:GetService("ReplicatedStorage"),
    VIM = game:GetService("VirtualInputManager"),
    Camera = workspace.CurrentCamera,
    GuiService = game:GetService("GuiService"),
    CoreGui = game:GetService("CoreGui"),
    TweenService = game:GetService("TweenService"),
    UserInputService = game:GetService("UserInputService"),
    TeleportService = game:GetService("TeleportService")
}

local LocalPlayer = Services.Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local function GetCharacter()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

local function GetHRP()
    local char = GetCharacter()
    return char:WaitForChild("HumanoidRootPart", 5)
end

-- HTTP Request handler
local httpRequest = nil
if syn and syn.request then httpRequest = syn.request
elseif http and http.request then httpRequest = http.request
elseif http_request then httpRequest = http_request
elseif fluxus and fluxus.request then httpRequest = fluxus.request
elseif request then httpRequest = request end
_G.httpRequest = httpRequest

-- Game modules - ONLY load Net and Replion (packages work, game scripts don't)
local Net = nil
local NetReady = false
local Replion = nil
local Data = nil

-- SAFE NET INITIALIZATION (Async to prevent UI delay)
task.spawn(function()
    pcall(function()
        local pkg = Services.RS:WaitForChild("Packages", 5)
        if pkg then
            local idx = pkg:WaitForChild("_Index", 3)
            if idx then
                local sl = idx:WaitForChild("sleitnick_net@0.2.0", 3)
                if sl then
                    Net = sl:WaitForChild("net", 3)
                    NetReady = true
                end
            end
        end
    end)

    if not NetReady then
        warn("[DanuHub] Net module not found - some features may not work")
    else
        print("[DanuHub] Net module loaded!")
        
        -- Initialize Minigame listener here once Net is ready
        pcall(function()
            if Net and Net["RE/FishingMinigameChanged"] then
                Net["RE/FishingMinigameChanged"].OnClientEvent:Connect(function(data, info)
                    if data and info then
                        _G.FishMiniData = info
                    end
                end)
            end
        end)
    end

    -- Get Replion for Data access (Async)
    pcall(function()
        Replion = require(Services.RS.Packages.Replion)
        if Replion and Replion.Client then
            Data = Replion.Client:WaitReplion("Data")
        end
    end)
end)

-- Safe Remote Functions
local function SafeFireServer(remotePath, ...)
    if not Net then return false end
    local args = {...}
    local success = pcall(function()
        local remote = Net[remotePath]
        if remote then remote:FireServer(unpack(args)) end
    end)
    return success
end

local function SafeInvokeServer(remotePath, ...)
    if not Net then return nil end
    local args = {...}
    local success, result = pcall(function()
        local remote = Net[remotePath]
        if remote then return remote:InvokeServer(unpack(args)) end
        return nil
    end)
    return success and result or nil
end

-- Replion init moved to async block above

-- GameModules table (simplified - no game script requires)
local GameModules = {
    Net = Net,
    Replion = Replion
}

-- Custom ItemUtility replacement (since we can't require the game's version)
local function GetItemDataFromId(itemId)
    local itemsFolder = Services.RS:FindFirstChild("Items")
    if not itemsFolder then return nil end
    
    for _, item in ipairs(itemsFolder:GetChildren()) do
        if item:IsA("ModuleScript") then
            local success, data = pcall(require, item)
            if success and data and data.Data and data.Data.Id == itemId then
                return data
            end
        end
    end
    return nil
end

GameModules.GetItemData = GetItemDataFromId

-- Config
local ConfigPath = "DanuHub_NEW/Config.json"
local PositionPath = "DanuHub_NEW/Position.json"

_G.Delay = _G.Delay or 0
_G.DelayComplete = _G.DelayComplete or 0.5
_G.Reel = _G.Reel or 1.9
_G.FishingDelay = _G.FishingDelay or 1.1
_G.Celestial = _G.Celestial or { DetectorCount = 0, InstantCount = 0 }
_G.TierFish = { [1] = "Common", [2] = "Uncommon", [3] = "Rare", [4] = "Epic", [5] = "Legendary", [6] = "Mythic", [7] = "Secret" }
_G.Variant = { "Galaxy", "Corrupt", "Gemstone", "Ghost", "Lightning", "Fairy Dust", "Gold", "Midnight", "Radioactive", "Stone", "Holographic", "Albino", "Bloodmoon", "Sandy", "Acidic", "Color Burn", "Festive", "Frozen" }
_G.WebhookRarities = _G.WebhookRarities or {}
_G.WebhookNames = _G.WebhookNames or {}
_G.WebhookFlags = _G.WebhookFlags or { FishCaught = { Enabled = false, URL = "" }, Stats = { Enabled = false, URL = "", Delay = 5 }, Disconnect = { Enabled = false, URL = "" } }

-- State
local State = {
    autoInstant = false, selectedEvents = {}, autoWeather = false, autoSellEnabled = false, autoFavEnabled = false,
    autoEventActive = false, canFish = true, savedCFrame = nil, sellMode = "Delay", sellDelay = 60, inputSellCount = 50,
    selectedName = {}, selectedRarity = {}, selectedVariant = {}, rods = {}, rodDisplayNames = {}, baits = {}, baitDisplayNames = {},
    selectedRodId = nil, selectedBaitId = nil, stuckThreshold = 15, fishingTimer = 0, frozen = false,
    autoEquipRod = false, supportEnabled = false, autoDeepSea = false, autoElement = false, autoWebhook = false,
    Totems = {}, TotemDisplayName = {}, Potions = {}, PotionDisplayName = {}, teleportTarget = nil,
    autoArtifact = false, autoBuyWeather = false, priorityEvent = nil, origCF = nil, curCF = nil,
    trade = {
        selectedPlayer = nil, selectedItem = nil, tradeAmount = 1, targetCoins = 0, trading = false,
        successCount = 0, totalToTrade = 0, currentGrouped = {}, selectedRarity = nil, rarityAmount = 1, teleportTarget = nil,
        awaiting = false, lastResult = nil, failCount = 0, sentCoins = 0, successCoins = 0, totalReceived = 0
    },
    ignore = {
        Cloudy = true, Day = true, ["Increased Luck"] = true, Mutated = true, Night = true, Snow = true,
        ["Sparkling Cove"] = true, Storm = true, Wind = true, UIListLayout = true,
        ["Admin - Shocked"] = true, ["Admin - Super Mutated"] = true, Radiant = true
    }
}

-- Locations
local Locations = {
    ["Moosewood"] = Vector3.new(-1524, 2, 1915),
    ["Roslit Bay"] = Vector3.new(-3270, 2, 2228),
    ["Snowcap"] = Vector3.new(2164, 7, 3269),
    ["Sunstone Island"] = Vector3.new(-561, 21, 156),
    ["Forsaken Shores"] = Vector3.new(-3737, 5, -854),
    ["Ancient Isle"] = Vector3.new(1274, 8, -184),
    ["Mushgrove Swamp"] = Vector3.new(-2018, 9, 3750),
    ["Treasure Room"] = Vector3.new(-3602, -266, -1577),
    ["Sisyphus Statue"] = Vector3.new(-3703, -135, -1017),
    ["Crater Island Top"] = Vector3.new(1011, 22, 5076),
    ["Crater Island Ground"] = Vector3.new(1079, 3, 5080),
    ["Coral Reefs SPOT 1"] = Vector3.new(-3031, 2, 2276),
    ["Coral Reefs SPOT 2"] = Vector3.new(-3270, 2, 2228),
    ["Weather Machine"] = Vector3.new(-1524, 2, 1915),
    ["Kohana Volcano"] = Vector3.new(-561, 21, 156),
    ["Kohana SPOT 1"] = Vector3.new(-367, 6, 521),
    ["Kohana SPOT 2"] = Vector3.new(-623, 19, 419),
    ["Stingray Shores"] = Vector3.new(44, 28, 3048),
    ["Tropical Grove"] = Vector3.new(-2018, 9, 3750),
    ["Ice Sea"] = Vector3.new(2164, 7, 3269),
    ["Tropical Grove Cave"] = Vector3.new(-2151, 3, 3671),
    ["Fisherman Island"] = Vector3.new(-62, 3, 2846),
    ["Sacred Temple"] = Vector3.new(1475, -22, -632),
    ["Ancient Jungle"] = Vector3.new(1274, 8, -184),
    ["Underground Cellar"] = Vector3.new(2136, -91, -699),
    ["Crystalline Passage"] = Vector3.new(6051, -539, 4386),
    ["Ancient Ruin"] = Vector3.new(6090, -586, 4634),
    ["Esoteric Deep"] = Vector3.new(3181, -1303, 1425),
    ["Classic Event"] = Vector3.new(1173, 4, 2839),
    ["Iron Cavern Right"] = Vector3.new(-8792, -585, 223),
    ["Iron Cavern Left"] = Vector3.new(-8795, -585, 89),
    ["Enchant Altar"] = Vector3.new(3258, -1301, 1391),
    ["Second Enchant Altar"] = Vector3.new(1480, 128, -593)
}

_G.artifactPositions = {
    ["Arrow Artifact"] = CFrame.new(875, 3, -368) * CFrame.Angles(0, math.rad(90), 0),
    ["Crescent Artifact"] = CFrame.new(1403, 3, 123) * CFrame.Angles(0, math.rad(180), 0),
    ["Hourglass Diamond Artifact"] = CFrame.new(1487, 3, -842) * CFrame.Angles(0, math.rad(180), 0),
    ["Diamond Artifact"] = CFrame.new(1844, 3, -287) * CFrame.Angles(0, math.rad(-90), 0)
}

local locationNames = {}
for name in pairs(Locations) do table.insert(locationNames, name) end
table.sort(locationNames)

-- Utility Functions
local function Notify(msg) print("[DanuHub] " .. tostring(msg)) end

local function GetFishCount()
    local s, r = pcall(function()
        return tonumber(PlayerGui.Inventory.Main.Top.Options.Fish.Label.BagSize.Text:match("(%d+)/")) or 0
    end)
    return s and r or 0
end

local function ToSet(tbl)
    local set = {}
    if type(tbl) == "table" then for _, v in ipairs(tbl) do set[v] = true end end
    return set
end

local function CleanName(name)
    if type(name) ~= "string" then return tostring(name) end
    return name:match("^(.-) %(") or name
end

local function GetPlayerList()
    local players = {}
    for _, p in ipairs(Services.Players:GetPlayers()) do
        if p ~= LocalPlayer then table.insert(players, p.Name) end
    end
    return players
end

local function Teleport(pos)
    local hrp = GetHRP()
    if hrp then
        if typeof(pos) == "Vector3" then
            hrp.CFrame = CFrame.new(pos + Vector3.new(0, 3, 0))
        else
            hrp.CFrame = pos
        end
    end
end

local function SavePosition(cf)
    if not writefile then return end
    pcall(function()
        local x, y, z = cf:GetComponents()
        writefile(PositionPath, Services.HttpService:JSONEncode({x, y, z}))
    end)
end

local function LoadPosition()
    if not isfile or not isfile(PositionPath) then return nil end
    local s, r = pcall(function()
        return CFrame.new(unpack(Services.HttpService:JSONDecode(readfile(PositionPath))))
    end)
    return s and r or nil
end

-- Build item lists
local FishList = {}
local ItemsFolder, BaitsFolder, TotemsFolder, PotionsFolder

task.spawn(function()
    pcall(function()
        ItemsFolder = Services.RS:FindFirstChild("Items")
        BaitsFolder = Services.RS:FindFirstChild("Baits")
        TotemsFolder = Services.RS:FindFirstChild("Totems")
        PotionsFolder = Services.RS:FindFirstChild("Potions")
        
        if ItemsFolder then
            for _, item in ipairs(ItemsFolder:GetChildren()) do
                if item:IsA("ModuleScript") then
                    local s, m = pcall(require, item)
                    if s and m and m.Data then
                        if m.Data.Type == "Fish" then
                            table.insert(FishList, m.Data.Name)
                        elseif item.Name:match("Rod") and m.Data.Type == "Fishing Rods" then
                            local id, name, price = m.Data.Id or "?", m.Data.Name or "?", m.Price or 0
                            State.rods[id] = { Name = name, Id = id, Price = price, Display = name .. " ($" .. price .. ")" }
                            State.rods[name] = State.rods[id]
                            table.insert(State.rodDisplayNames, State.rods[id].Display)
                        end
                    end
                end
            end
        end
        table.sort(FishList)
        
        if BaitsFolder then
            for _, item in ipairs(BaitsFolder:GetChildren()) do
                if item:IsA("ModuleScript") then
                    local s, m = pcall(require, item)
                    if s and m and m.Data then
                        local id, name, price = m.Data.Id or "?", m.Data.Name or "?", m.Price or 0
                        State.baits[id] = { Name = name, Id = id, Price = price, Display = name .. " ($" .. price .. ")" }
                        State.baits[name] = State.baits[id]
                        table.insert(State.baitDisplayNames, State.baits[id].Display)
                    end
                end
            end
        end
        
        if TotemsFolder then
            for _, item in ipairs(TotemsFolder:GetChildren()) do
                if item:IsA("ModuleScript") then
                    local s, m = pcall(require, item)
                    if s and m and m.Data then
                        local id, name = m.Data.Id or "?", m.Data.Name or "?"
                        State.Totems[id] = { Name = name, Id = id }
                        State.Totems[name] = State.Totems[id]
                        table.insert(State.TotemDisplayName, name)
                    end
                end
            end
        end
        
        if PotionsFolder then
            for _, item in ipairs(PotionsFolder:GetChildren()) do
                if item:IsA("ModuleScript") then
                    local s, m = pcall(require, item)
                    if s and m and m.Data and not string.find(string.lower(m.Data.Name or ""), "totem") then
                        local id, name = m.Data.Id or "?", m.Data.Name or "?"
                        State.Potions[id] = { Name = name, Id = id }
                        State.Potions[name] = State.Potions[id]
                        table.insert(State.PotionDisplayName, name)
                    end
                end
            end
        end
    end)
end)

-- Minigame listener moved to async block above

-- Fishing functions (PERSIS SEPERTI DanuHub_NEW_Full.lua)
local CosmeticFolder = workspace:FindFirstChild("CosmeticFolder")
local userId = tostring(LocalPlayer.UserId)

-- Helper fishing functions using SafeFireServer/SafeInvokeServer
local function CancelFishingRemote()
    SafeInvokeServer("RF/CancelFishingInputs")
end

local function ChargeRodRemote(serverTime)
    SafeInvokeServer("RF/ChargeFishingRod", serverTime)
end

local function StartMinigame(angle, power, serverTime)
    angle = angle or -1
    power = power or 0.999
    SafeInvokeServer("RF/RequestFishingMinigameStarted", angle, power, serverTime)
end

local function CompleteFishing()
    SafeFireServer("RE/FishingCompleted")
end

local function CancelFishing()
    CancelFishingRemote()
    LocalPlayer:SetAttribute("Loading", nil)
    task.wait(0.05)
    LocalPlayer:SetAttribute("Loading", false)
end

-- Klik tengah layar untuk fishing
local function ClickScreen()
    local vp = Services.Camera.ViewportSize
    Services.VIM:SendMouseButtonEvent(vp.X/2, vp.Y/2, 0, true, game, 0)
    task.wait()
    Services.VIM:SendMouseButtonEvent(vp.X/2, vp.Y/2, 0, false, game, 0)
end

-- Auto Shake - use VIM click
local function DoAutoShake()
    pcall(function()
        ClickScreen()
    end)
end

-- Cast with Bar Release untuk Legit Fishing
local barReleaseCallback = nil

local function CastWithBarRelease()
    CancelFishingRemote()
    
    -- Charge rod via remote
    SafeInvokeServer("RF/ChargeFishingRod", workspace:GetServerTimeNow())
    
    local chargeBar = PlayerGui:FindFirstChild("Charge")
    if chargeBar then
        local main = chargeBar:FindFirstChild("Main")
        if main then
            local canvas = main:FindFirstChild("CanvasGroup")
            if canvas then
                local bar = canvas:FindFirstChild("Bar")
                if bar then
                    local startTime = tick()
                    while bar:IsDescendantOf(game) and bar.Size.Y.Scale < 0.93 do
                        task.wait()
                        if tick() - startTime > 2 then break end
                    end
                end
            end
        end
    end
    
    if barReleaseCallback then
        pcall(barReleaseCallback)
    end
end

-- Instant Fishing - FIXED (PERSIS SEPERTI DanuHub_NEW_Full.lua)
local function InstantFishing()
    if not State.canFish then return end
    State.canFish = false
    
    task.spawn(function()
        pcall(function()
            local serverTime = workspace:GetServerTimeNow()
            
            -- Step 1: Charge rod
            ChargeRodRemote(serverTime)
            task.wait(0.3)
            
            -- Step 2: Start minigame dengan serverTime
            StartMinigame(-1, 0.999, serverTime)
            
            -- Step 3: Tunggu minigame data atau timeout
            local waitStart = tick()
            while not _G.FishMiniData and (tick() - waitStart) < 1 do
                task.wait()
            end
            
            -- Step 4: Tunggu delay complete
            task.wait(_G.DelayComplete or 0.5)
            
            -- Step 5: Complete fishing
            CompleteFishing()
            
            -- Step 6: Tunggu fish count berubah
            local startCount = GetFishCount()
            local startTime = tick()
            while GetFishCount() == startCount and (tick() - startTime) < 1 do
                task.wait()
            end
            
            -- Step 7: Cancel dan reset
            CancelFishingRemote()
            _G.FishMiniData = nil
        end)
        
        State.canFish = true
    end)
end

-- Blatant/Fastest Fishing - FIXED (PERSIS SEPERTI DanuHub_NEW_Full.lua)
local function FastestFishing()
    task.spawn(function()
        pcall(function()
            CancelFishingRemote()
        end)
        pcall(function()
            ChargeRodRemote(workspace:GetServerTimeNow())
        end)
        pcall(function()
            StartMinigame(-1, 0.999)
        end)
        task.wait(_G.FishingDelay or 1.1)
        pcall(function()
            CompleteFishing()
        end)
    end)
end

-- Recovery fishing
local function RecoveryFishing()
    CancelFishingRemote()
    LocalPlayer:SetAttribute("Loading", nil)
    task.wait(0.05)
    LocalPlayer:SetAttribute("Loading", false)
end

-- Walk on Water
local WOWPart, WOWConn, WOWEnabled = nil, nil, false

local function SetupWalkOnWater(enabled)
    WOWEnabled = enabled
    if WOWConn then WOWConn:Disconnect(); WOWConn = nil end
    if WOWPart then WOWPart:Destroy(); WOWPart = nil end
    
    if enabled then
        local hrp = GetHRP()
        if not hrp then return end
        
        WOWPart = Instance.new("Part")
        WOWPart.Name = "WW_Part"
        WOWPart.Size = Vector3.new(15, 1, 15)
        WOWPart.Anchored = true
        WOWPart.CanCollide = false
        WOWPart.Transparency = 1
        WOWPart.Parent = workspace
        
        WOWConn = Services.RunService.Heartbeat:Connect(function()
            if not WOWEnabled or not WOWPart or not hrp then return end
            WOWPart.Position = Vector3.new(hrp.Position.X, -1.8, hrp.Position.Z)
            WOWPart.CanCollide = hrp.Position.Y >= -1.8
        end)
    end
end

-- Quest functions - FIXED
local function ReadTracker(trackerName)
    local menuRings = workspace:FindFirstChild("!!! MENU RINGS")
    if not menuRings then return "" end
    local tracker = menuRings:FindFirstChild(trackerName)
    if not tracker then return "" end
    local board = tracker:FindFirstChild("Board")
    if not board then return "" end
    local gui = board:FindFirstChild("Gui")
    if not gui then return "" end
    local content = gui:FindFirstChild("Content")
    if not content then return "" end
    
    local lines = {}
    local i = 1
    for _, child in ipairs(content:GetChildren()) do
        if child:IsA("TextLabel") and child.Name ~= "Header" then
            table.insert(lines, i .. ". " .. child.Text)
            i = i + 1
        end
    end
    return table.concat(lines, "\n")
end

local function HasArtifactWorld(artifactName)
    local ji = workspace:FindFirstChild("JUNGLE INTERACTIONS")
    if not ji then return false end
    local searchName = artifactName:lower():gsub(" artifact", "")
    for _, desc in ipairs(ji:GetDescendants()) do
        if desc:IsA("Model") and desc.Name == "TempleLever" then
            local lt = desc:GetAttribute("Type")
            if lt and tostring(lt):lower():find(searchName) then
                local rootPart = desc:FindFirstChild("RootPart")
                if rootPart then
                    return rootPart:FindFirstChildWhichIsA("ProximityPrompt") ~= nil
                end
            end
        end
    end
    return false
end

local function ActivateArtifact(artifactName)
    local ji = workspace:FindFirstChild("JUNGLE INTERACTIONS")
    if not ji then return end
    local searchName = artifactName:lower():gsub(" artifact", "")
    for _, desc in ipairs(ji:GetDescendants()) do
        if desc:IsA("Model") and desc.Name == "TempleLever" then
            local lt = desc:GetAttribute("Type")
            if lt and tostring(lt):lower():find(searchName) then
                local rootPart = desc:FindFirstChild("RootPart")
                if rootPart then
                    local prompt = rootPart:FindFirstChildWhichIsA("ProximityPrompt")
                    if prompt and fireproximityprompt then
                        fireproximityprompt(prompt)
                    end
                end
            end
        end
    end
end

-- Get Events from GUI - FIXED
local function GetActiveEvents()
    local events = {}
    local eventGui = PlayerGui:FindFirstChild("Events")
    if not eventGui then return events end
    
    local frame = eventGui:FindFirstChild("Frame")
    if not frame then return events end
    
    local eventsFrame = frame:FindFirstChild("Events")
    if not eventsFrame then return events end
    
    for _, child in ipairs(eventsFrame:GetChildren()) do
        if child:IsA("Frame") and child:FindFirstChild("DisplayName") then
            local name = child.DisplayName.Text
            if name and name ~= "" and not State.ignore[name] then
                table.insert(events, name:gsub("^Admin %- ", ""))
            end
        end
    end
    return events
end

-- Find Event Part - FIXED
local function FindEventPart(eventName)
    if not eventName then return nil end
    
    if eventName == "Megalodon Hunt" then
        local menuRings = workspace:FindFirstChild("!!! MENU RINGS")
        if menuRings then
            for _, child in ipairs(menuRings:GetChildren()) do
                local megalodon = child:FindFirstChild("Megalodon Hunt")
                if megalodon and megalodon:IsA("BasePart") then
                    return megalodon
                end
            end
        end
    end
    
    local props = workspace:FindFirstChild("Props")
    if props then
        for _, propFolder in ipairs(props:GetChildren()) do
            if propFolder.Name:match("^Props") then
                for _, model in ipairs(propFolder:GetChildren()) do
                    for _, desc in ipairs(model:GetDescendants()) do
                        if desc:IsA("TextLabel") and desc.Name == "DisplayName" then
                            if desc.Text:lower() == eventName:lower() then
                                local part = model:FindFirstChild("Part")
                                if part and part:IsA("BasePart") then
                                    return part
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    return nil
end

-- Trade functions - FIXED
local function GetGroupedByType(itemType)
    local grouped, display = {}, {}
    if not Data then return grouped, display end
    
    local success, items = pcall(function()
        return Data:GetExpect({"Inventory", "Items"})
    end)
    if not success or not items then return grouped, display end
    
    for _, item in ipairs(items) do
        if not item.Favorited then
            local itemData = nil
            pcall(function()
                itemData = GetItemDataFromId(item.Id)
            end)
            if itemData and itemData.Data and itemData.Data.Type == itemType then
                local name = itemData.Data.Name or "Unknown"
                if not grouped[name] then grouped[name] = { count = 0, uuids = {} } end
                grouped[name].count = grouped[name].count + (item.Quantity or 1)
                table.insert(grouped[name].uuids, item.UUID)
            end
        end
    end
    for name, data in pairs(grouped) do
        table.insert(display, string.format("%s x%d", name, data.count))
    end
    return grouped, display
end

local function GetGroupedByRarity(rarity)
    local grouped, display = {}, {}
    if not Data then return grouped, display end
    
    local success, items = pcall(function()
        return Data:GetExpect({"Inventory", "Items"})
    end)
    if not success or not items then return grouped, display end
    
    for _, item in ipairs(items) do
        if not item.Favorited then
            local itemData = nil
            pcall(function()
                itemData = GetItemDataFromId(item.Id)
            end)
            if itemData and itemData.Data and itemData.Data.Type == "Fish" then
                local tier = _G.TierFish[itemData.Data.Tier] or "Unknown"
                if tier == rarity then
                    local name = itemData.Data.Name or "Unknown"
                    if not grouped[name] then grouped[name] = { count = 0, uuids = {} } end
                    grouped[name].count = grouped[name].count + 1
                    table.insert(grouped[name].uuids, item.UUID)
                end
            end
        end
    end
    for name, data in pairs(grouped) do
        table.insert(display, string.format("%s x%d", name, data.count))
    end
    return grouped, display
end

-- Check if item still exists
local function CheckItemExists(uuid)
    if not Data then return false end
    local success, items = pcall(function()
        return Data:GetExpect({"Inventory", "Items"})
    end)
    if not success or not items then return false end
    
    for _, item in ipairs(items) do
        if item.UUID == uuid then
            return true
        end
    end
    return false
end

-- Execute Trade - FIXED with retry
local function ExecuteTrade(playerName, uuid, itemName, retryCount)
    retryCount = retryCount or 0
    if not Net then return false end
    
    local targetPlayer = Services.Players:FindFirstChild(playerName)
    if not targetPlayer then
        Notify("Player not found: " .. playerName)
        return false
    end
    
    State.trade.awaiting = true
    local success = pcall(function()
        SafeInvokeServer("RF/InitiateTrade", targetPlayer.UserId, uuid)
    end)
    
    if not success then
        State.trade.awaiting = false
        return false
    end
    
    -- Wait for trade to complete
    local startTime = tick()
    while State.trade.awaiting and (tick() - startTime) < 10 do
        if not CheckItemExists(uuid) then
            State.trade.awaiting = false
            Notify("Sent " .. (itemName or "item") .. " to " .. playerName)
            return true
        end
        task.wait(0.2)
    end
    
    State.trade.awaiting = false
    
    -- Retry logic
    if retryCount < 3 and State.trade.trading then
        task.wait(1)
        return ExecuteTrade(playerName, uuid, itemName, retryCount + 1)
    end
    
    return false
end

-- Webhook
local function SendWebhook(url, payload)
    if not _G.httpRequest or not url or url == "" then return end
    pcall(function()
        _G.httpRequest({ Url = url, Method = "POST", Headers = { ["Content-Type"] = "application/json" }, Body = Services.HttpService:JSONEncode(payload) })
    end)
end

-- Totem functions - FIXED
local function GetTotemInfo()
    local totems = {}
    local hrp = GetHRP()
    local playerPos = hrp and hrp.Position or Vector3.zero
    
    local totemsFolder = workspace:FindFirstChild("Totems")
    if not totemsFolder then return totems end
    
    for _, totem in ipairs(totemsFolder:GetChildren()) do
        if totem:IsA("Model") then
            local handle = totem:FindFirstChild("Handle")
            if handle then
                local overhead = handle:FindFirstChild("Overhead")
                if overhead then
                    local content = overhead:FindFirstChild("Content")
                    if content then
                        local header = content:FindFirstChild("Header")
                        local timer = content:FindFirstChild("TimerLabel")
                        
                        local name = header and header.Text or "??"
                        local timeLeft = timer and timer.Text or "??"
                        local distance = (playerPos - totem:GetPivot().Position).Magnitude
                        
                        table.insert(totems, {
                            Name = name,
                            Distance = distance,
                            TimeLeft = timeLeft
                        })
                    end
                end
            end
        end
    end
    return totems
end

-- Get Enchant Info - FIXED
local function GetEnchantInfo(enchantStoneId)
    enchantStoneId = enchantStoneId or 10
    local rodName = "None"
    local enchantName = "None"
    local stoneCount = 0
    local stoneUUIDs = {}
    
    if not Data then return rodName, enchantName, stoneCount, stoneUUIDs end
    
    pcall(function()
        local equippedItems = Data:Get({"EquippedItems"}) or {}
        local rods = Data:Get({"Inventory", "Fishing Rods"}) or {}
        
        for slot, uuid in pairs(equippedItems) do
            for _, rod in ipairs(rods) do
                if rod.UUID == uuid then
                    local itemData = GetItemDataFromId(rod.Id)
                    if itemData and itemData.Data then
                        rodName = itemData.Data.Name or "Unknown"
                    end
                    
                    if rod.Metadata and rod.Metadata.EnchantId then
                        -- Try to get enchant name from Enchants folder
                        pcall(function()
                            local enchantsFolder = Services.RS:FindFirstChild("Enchants")
                            if enchantsFolder then
                                for _, ench in ipairs(enchantsFolder:GetChildren()) do
                                    if ench:IsA("ModuleScript") then
                                        local ok, enchData = pcall(require, ench)
                                        if ok and enchData and enchData.Data and enchData.Data.Id == rod.Metadata.EnchantId then
                                            enchantName = enchData.Data.Name or "None"
                                            break
                                        end
                                    end
                                end
                            end
                        end)
                    end
                    break
                end
            end
        end
        
        local items = Data:GetExpect({"Inventory", "Items"}) or {}
        for _, item in ipairs(items) do
            if item.Id == enchantStoneId then
                stoneCount = stoneCount + (item.Amount or 1)
                table.insert(stoneUUIDs, item.UUID)
            end
        end
    end)
    
    return rodName, enchantName, stoneCount, stoneUUIDs
end

-- Auto teleport last position
LocalPlayer.CharacterAdded:Connect(function(char)
    task.spawn(function()
        local pos = LoadPosition()
        if pos then
            task.wait(2)
            local hrp = char:WaitForChild("HumanoidRootPart", 5)
            if hrp then hrp.CFrame = pos; Notify("Teleported to last position") end
        end
    end)
end)

-- ==================== CUSTOM LUXURY UI LIBRARY ====================
print("[DanuHub] Loading Custom Luxury UI...")

local function DisableAllFeatures()
    for k, v in pairs(State) do
        if type(v) == "boolean" then State[k] = false end
    end
    _G.FishingDelay = 1.1
    _G.EnchantFarm = false
    _G.AntiStaff = false
    _G.DelEffects = false
    _G.IrRod = false
    if _G.WebhookFlags then
        _G.WebhookFlags.FishCaught.Enabled = false
        _G.WebhookFlags.Stats.Enabled = false
    end
    State.autoDeepSea = false
    State.autoElement = false
    State.autoArtifact = false
    pcall(function() SafeInvokeServer("RF/CancelFishingInputs") end)
    LocalPlayer:SetAttribute("Loading", false)
    Notify("All features disabled.")
end

local UI = {}
local TweenService = Services.TweenService

-- Colors
local Colors = {
    Gradient1 = Color3.fromRGB(80, 0, 120), -- Deep Purple
    Gradient2 = Color3.fromRGB(100, 0, 0),  -- Deep Red
    Text = Color3.fromRGB(240, 240, 240),
    TextDark = Color3.fromRGB(180, 180, 180),
    Element = Color3.fromRGB(20, 20, 20),
    Accent = Color3.fromRGB(255, 255, 255)
}

-- Animation Helper (Global)
local function AddHoverClickAnim(btn, scaleTarget)
    scaleTarget = scaleTarget or btn
    local uiScale = scaleTarget:FindFirstChild("UIScale") or Instance.new("UIScale")
    uiScale.Parent = scaleTarget
    
    btn.MouseEnter:Connect(function()
        Services.TweenService:Create(uiScale, TweenInfo.new(0.2), {Scale = 1.1}):Play()
    end)
    
    btn.MouseLeave:Connect(function()
        Services.TweenService:Create(uiScale, TweenInfo.new(0.2), {Scale = 1}):Play()
    end)
    
    btn.MouseButton1Down:Connect(function()
        Services.TweenService:Create(uiScale, TweenInfo.new(0.1), {Scale = 0.9}):Play()
    end)
    
    btn.MouseButton1Up:Connect(function()
        Services.TweenService:Create(uiScale, TweenInfo.new(0.1), {Scale = 1.1}):Play()
    end)
end

function UI:CreateWindow(title)
    if Services.CoreGui:FindFirstChild("DanuHub_Luxury") then
        Services.CoreGui:FindFirstChild("DanuHub_Luxury"):Destroy()
    end

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "DanuHub_Luxury"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    pcall(function() ScreenGui.Parent = Services.CoreGui end)
    if not ScreenGui.Parent then ScreenGui.Parent = PlayerGui end

    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 650, 0, 400)
    MainFrame.Position = UDim2.new(0.5, -325, 0.5, -200)
    MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15) -- Solid Dark for Title Area
    MainFrame.BackgroundTransparency = 0.3 -- Lebih Solid (Opacity Increased)
    MainFrame.ClipsDescendants = true
    MainFrame.Parent = ScreenGui

    -- Corner
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 10)
    UICorner.Parent = MainFrame

    -- Stroke
    local UIStroke = Instance.new("UIStroke")
    UIStroke.Color = Colors.Gradient1
    UIStroke.Thickness = 2
    UIStroke.Transparency = 0.5
    UIStroke.Parent = MainFrame
    
    -- (Gradient dipindah ke ContentContainer agar tidak menimpa Title)
    
    -- Dragging Logic (Fixed)
    local dragging, dragInput, dragStart, startPos
    
    local function Update(input)
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    MainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    MainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    Services.UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            Update(input)
        end
    end)

    -- Resizer (Bottom Right)
    local Resizer = Instance.new("ImageButton")
    Resizer.Name = "Resizer"
    Resizer.Size = UDim2.new(0, 40, 0, 40) -- Area sentuh lebih besar (Android friendly)
    Resizer.Position = UDim2.new(1, 0, 1, 0)
    Resizer.AnchorPoint = Vector2.new(1, 1)
    Resizer.BackgroundTransparency = 1
    Resizer.Image = "rbxassetid://4667373079" -- Grip Icon
    Resizer.ImageColor3 = Color3.fromRGB(200, 200, 200)
    Resizer.ImageTransparency = 0.5
    Resizer.Parent = MainFrame
    
    local resizing = false
    local resizeInput = nil
    local resizeStart = Vector3.zero
    local startSize = Vector2.zero
    
    Resizer.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            resizing = true
            resizeInput = input 
            resizeStart = input.Position
            startSize = MainFrame.AbsoluteSize
        end
    end)
    
    Services.UserInputService.InputChanged:Connect(function(input)
        if resizing then
            local isMouse = input.UserInputType == Enum.UserInputType.MouseMovement
            local isTouch = input.UserInputType == Enum.UserInputType.Touch
            
            -- PC: MouseMovement, Mobile: Touch (Same Input Object)
            if isMouse or (isTouch and input == resizeInput) then
                local delta = input.Position - resizeStart
                local newW = math.max(350, startSize.X + delta.X)
                local newH = math.max(250, startSize.Y + delta.Y)
                MainFrame.Size = UDim2.new(0, newW, 0, newH)
            end
        end
    end)
    
    Services.UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input == resizeInput then
            resizing = false
            resizeInput = nil
        end
    end)

    -- Sidebar
    local Sidebar = Instance.new("Frame")
    Sidebar.Name = "Sidebar"
    Sidebar.Size = UDim2.new(0, 160, 1, 0)
    Sidebar.BackgroundColor3 = Color3.fromRGB(0, 0, 0) -- Black
    Sidebar.BackgroundTransparency = 1 -- Transparan mengikuti MainFrame
    Sidebar.BorderSizePixel = 0
    Sidebar.Parent = MainFrame
    
    -- Horizontal Separator (Line below Header)
    local H_Separator = Instance.new("Frame")
    H_Separator.Name = "HSeparator"
    H_Separator.Size = UDim2.new(1, 0, 0, 2) -- Lebih tebal (2px)
    H_Separator.Position = UDim2.new(0, 0, 0, 60) -- Adjusted for larger header
    H_Separator.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    H_Separator.BackgroundTransparency = 0.5 -- Lebih Transparan
    H_Separator.BorderSizePixel = 0
    H_Separator.Parent = MainFrame

    -- Vertical Separator (Line between Sidebar and Content)
    local V_Separator = Instance.new("Frame")
    V_Separator.Name = "VSeparator"
    V_Separator.Size = UDim2.new(0, 2, 1, -60) -- Adjusted height
    V_Separator.Position = UDim2.new(0, 160, 0, 60) -- Adjusted Y
    V_Separator.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    V_Separator.BackgroundTransparency = 0.5 -- Lebih Transparan
    V_Separator.BorderSizePixel = 0
    V_Separator.Parent = MainFrame

    -- Toggle Button (Separate GUI for reliability)
    local ToggleGui = Instance.new("ScreenGui")
    ToggleGui.Name = "DanuHub_Toggle"
    ToggleGui.ResetOnSpawn = false
    ToggleGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    if Services.CoreGui:FindFirstChild("DanuHub_Toggle") then
        Services.CoreGui:FindFirstChild("DanuHub_Toggle"):Destroy()
    end
    pcall(function() ToggleGui.Parent = Services.CoreGui end)
    if not ToggleGui.Parent then ToggleGui.Parent = PlayerGui end

    local ToggleBtn = Instance.new("ImageButton")
    ToggleBtn.Name = "MiniToggle"
    ToggleBtn.Size = UDim2.new(0, 50, 0, 50)
    ToggleBtn.Position = UDim2.new(0, 10, 0, 10) -- Top Left
    ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    ToggleBtn.BackgroundTransparency = 0.5
    ToggleBtn.Image = "rbxassetid://79215279738637" -- New Icon
    ToggleBtn.ImageColor3 = Color3.fromRGB(255, 255, 255)
    ToggleBtn.Visible = false -- Hidden by default
    ToggleBtn.Parent = ToggleGui
    
    Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(1, 0) -- Circle
    Instance.new("UIStroke", ToggleBtn).Color = Colors.Gradient1
    Instance.new("UIStroke", ToggleBtn).Thickness = 2
    
    AddHoverClickAnim(ToggleBtn)

    -- Draggable Toggle
    local draggingT, dragInputT, dragStartT, startPosT
    ToggleBtn.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            draggingT = true
            dragStartT = input.Position
            startPosT = ToggleBtn.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    draggingT = false
                end
            end)
        end
    end)
    ToggleBtn.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInputT = input
        end
    end)
    Services.UserInputService.InputChanged:Connect(function(input)
        if input == dragInputT and draggingT then
            local delta = input.Position - dragStartT
            ToggleBtn.Position = UDim2.new(startPosT.X.Scale, startPosT.X.Offset + delta.X, startPosT.Y.Scale, startPosT.Y.Offset + delta.Y)
        end
    end)

    ToggleBtn.MouseButton1Click:Connect(function()
        MainFrame.Visible = true
        ToggleBtn.Visible = false
    end)

    -- Window Controls (Close & Minimize)
    local Controls = Instance.new("Frame")
    Controls.Name = "Controls"
    Controls.Size = UDim2.new(0, 60, 0, 30)
    Controls.Position = UDim2.new(1, -65, 0, 5)
    Controls.BackgroundTransparency = 1
    Controls.Parent = MainFrame

    local CloseBtn = Instance.new("TextButton")
    CloseBtn.Name = "Close"
    CloseBtn.Size = UDim2.new(0, 25, 0, 25)
    CloseBtn.Position = UDim2.new(1, -25, 0, 0)
    CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    CloseBtn.BackgroundTransparency = 0.2
    CloseBtn.Text = "X"
    CloseBtn.TextColor3 = Colors.Text
    CloseBtn.Font = Enum.Font.GothamBold
    CloseBtn.TextSize = 14
    CloseBtn.Parent = Controls
    
    Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(0, 6)
    AddHoverClickAnim(CloseBtn)

    local MinBtn = Instance.new("TextButton")
    MinBtn.Name = "Minimize"
    MinBtn.Size = UDim2.new(0, 25, 0, 25)
    MinBtn.Position = UDim2.new(1, -55, 0, 0)
    MinBtn.BackgroundColor3 = Color3.fromRGB(200, 150, 50)
    MinBtn.BackgroundTransparency = 0.2
    MinBtn.Text = "-"
    MinBtn.TextColor3 = Colors.Text
    MinBtn.Font = Enum.Font.GothamBold
    MinBtn.TextSize = 14
    MinBtn.Parent = Controls

    Instance.new("UICorner", MinBtn).CornerRadius = UDim.new(0, 6)
    AddHoverClickAnim(MinBtn)

    CloseBtn.MouseButton1Click:Connect(function()
        DisableAllFeatures() -- Mematikan semua fitur fishing/farm dll
        
        if ScreenGui then ScreenGui:Destroy() end -- Hapus Main GUI
        if ToggleGui then ToggleGui:Destroy() end -- Hapus Toggle Button
        
        -- Reset reference variables
        ScreenGui = nil 
        ToggleGui = nil
        
        -- Notify user
        Notify("Script closed and features disabled.")
    end)

    MinBtn.MouseButton1Click:Connect(function()
        MainFrame.Visible = false
        ToggleBtn.Visible = true
    end)

    -- Tab Container (Holds Menu Buttons)
    local TabContainer = Instance.new("Frame")
    TabContainer.Name = "TabContainer"
    TabContainer.Size = UDim2.new(1, 0, 1, -115) -- Full Height - Header(55) - Profile(60)
    TabContainer.Position = UDim2.new(0, 0, 0, 55) -- Start below Header
    TabContainer.BackgroundTransparency = 1
    TabContainer.Parent = Sidebar

    local SideLayout = Instance.new("UIListLayout")
    SideLayout.SortOrder = Enum.SortOrder.LayoutOrder
    SideLayout.Padding = UDim.new(0, 2) 
    SideLayout.Parent = TabContainer -- Changed Parent

    local SidePadding = Instance.new("UIPadding")
    SidePadding.PaddingTop = UDim.new(0, 5)
    SidePadding.PaddingLeft = UDim.new(0, 10)
    SidePadding.Parent = TabContainer -- Changed Parent
    
    -- Profile Section (Bottom)
    local ProfileFrame = Instance.new("Frame")
    ProfileFrame.Name = "Profile"
    ProfileFrame.Size = UDim2.new(1, 0, 0, 60)
    ProfileFrame.Position = UDim2.new(0, 0, 1, 0)
    ProfileFrame.AnchorPoint = Vector2.new(0, 1)
    ProfileFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    ProfileFrame.BackgroundTransparency = 0.9 -- Very transparent
    ProfileFrame.BorderSizePixel = 0
    ProfileFrame.Parent = Sidebar
    
    local Avatar = Instance.new("ImageLabel")
    Avatar.Size = UDim2.new(0, 36, 0, 36)
    Avatar.Position = UDim2.new(0, 10, 0.5, 0)
    Avatar.AnchorPoint = Vector2.new(0, 0.5)
    Avatar.BackgroundTransparency = 1
    pcall(function()
        Avatar.Image = Services.Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size48x48)
    end)
    Avatar.Parent = ProfileFrame
    Instance.new("UICorner", Avatar).CornerRadius = UDim.new(1, 0)
    
    local DisplayName = Instance.new("TextLabel")
    DisplayName.Size = UDim2.new(1, -56, 0, 18)
    DisplayName.Position = UDim2.new(0, 56, 0.5, -10)
    DisplayName.BackgroundTransparency = 1
    DisplayName.Text = LocalPlayer.DisplayName
    DisplayName.TextColor3 = Color3.fromRGB(255, 255, 255)
    DisplayName.Font = Enum.Font.GothamBold
    DisplayName.TextSize = 13
    DisplayName.TextXAlignment = Enum.TextXAlignment.Left
    DisplayName.Parent = ProfileFrame
    
    local Username = Instance.new("TextLabel")
    Username.Size = UDim2.new(1, -56, 0, 14)
    Username.Position = UDim2.new(0, 56, 0.5, 6)
    Username.BackgroundTransparency = 1
    Username.Text = "@" .. LocalPlayer.Name
    Username.TextColor3 = Color3.fromRGB(180, 180, 180)
    Username.Font = Enum.Font.Gotham
    Username.TextSize = 11
    Username.TextXAlignment = Enum.TextXAlignment.Left
    Username.Parent = ProfileFrame

    -- Header (Title + Subtitle)
    local HeaderFrame = Instance.new("Frame")
    HeaderFrame.Name = "Header"
    HeaderFrame.Size = UDim2.new(1, 0, 0, 55)
    HeaderFrame.BackgroundTransparency = 1
    HeaderFrame.LayoutOrder = 0
    HeaderFrame.Parent = Sidebar

    -- Main Title "DANUHUB"
    local MainTitle = Instance.new("TextLabel")
    MainTitle.Name = "MainTitle"
    MainTitle.Size = UDim2.new(1, -20, 0, 30)
    MainTitle.Position = UDim2.new(0, 10, 0, 5)
    MainTitle.BackgroundTransparency = 1
    MainTitle.Text = "DANUHUB"
    MainTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    MainTitle.Font = Enum.Font.Sarpanch
    MainTitle.TextSize = 26
    MainTitle.TextXAlignment = Enum.TextXAlignment.Left
    MainTitle.Parent = HeaderFrame
    
    local TGradient = Instance.new("UIGradient")
    TGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 255)), 
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0, 255, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 0, 255))
    })
    TGradient.Parent = MainTitle
    
    task.spawn(function()
        local rot = 0
        while MainTitle.Parent do
            rot = rot + 2
            TGradient.Rotation = rot
            task.wait(0.05)
        end
    end)

    -- Subtitle "LUXURY"
    local SubTitle = Instance.new("TextLabel")
    SubTitle.Size = UDim2.new(1, -20, 0, 15)
    SubTitle.Position = UDim2.new(0, 12, 0, 32)
    SubTitle.BackgroundTransparency = 1
    SubTitle.Text = "L U X U R Y   E D I T I O N"
    SubTitle.TextColor3 = Color3.fromRGB(255, 215, 0) -- Gold
    SubTitle.Font = Enum.Font.Gotham
    SubTitle.TextSize = 10
    SubTitle.TextXAlignment = Enum.TextXAlignment.Left
    SubTitle.Parent = HeaderFrame

    -- Content Container
    local ContentContainer = Instance.new("Frame")
    ContentContainer.Name = "Content"
    -- Y=62 starts exactly below the 2px separator (60+2)
    -- X=162 starts exactly after the 2px vertical separator (160+2)
    ContentContainer.Size = UDim2.new(1, -162, 1, -62) 
    ContentContainer.Position = UDim2.new(0, 162, 0, 62) 
    ContentContainer.BackgroundColor3 = Color3.fromRGB(255, 255, 255) -- White base for Gradient
    ContentContainer.BackgroundTransparency = 0.5 -- Semi-transparan agar gradient terlihat tapi tembus
    ContentContainer.ClipsDescendants = true -- Fix text spill
    ContentContainer.Parent = MainFrame

    -- Gradient for Content Only
    local ContentGradient = Instance.new("UIGradient")
    ContentGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(180, 0, 0)),   -- Dark Red Top/Left
        ColorSequenceKeypoint.new(1, Color3.fromRGB(10, 10, 10))   -- Almost Black Bottom/Right
    })
    ContentGradient.Rotation = 45
    ContentGradient.Parent = ContentContainer

    -- Tab System
    local Tabs = {}
    local CurrentTab = nil
    local isAnimating = false -- Animation Lock

    local function SwitchTab(newTab)
        if CurrentTab == newTab then return end
        if isAnimating then return end -- Lock: Prevent overlapping animations
        
        isAnimating = true
        -- SETTING: Slide Animation Speed
        local animSpeed = 0.4
        local tInfo = TweenInfo.new(animSpeed, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)

        -- Determine Direction: DOWN or UP based on button LayoutOrder
        local direction = 1 -- 1 = Down (Default)
        if CurrentTab and newTab.Button.LayoutOrder < CurrentTab.Button.LayoutOrder then
            direction = -1 -- Up
        end
        
        -- 1. Exit Animation (Old Menu)
        if CurrentTab then
            local oldPage = CurrentTab.Page
            
            -- Reset AnchorPoint to TopLeft (default) for cleaner slide logic
            oldPage.AnchorPoint = Vector2.new(0, 0)
            oldPage.Position = UDim2.new(0, 0, 0, 0)
            
            -- Slide Out: Ke Atas (kalau arah Down) atau Ke Bawah (kalau arah Up)
            -- Target position: Y = -1 (Up) or 1 (Down)
            local targetY = -1 * direction
            
            local tweenPos = TweenService:Create(oldPage, tInfo, {Position = UDim2.new(0, 0, targetY, 0)})
            local tweenFade = TweenService:Create(oldPage, tInfo, {GroupTransparency = 1})
            
            tweenPos:Play()
            tweenFade:Play()
            
            TweenService:Create(CurrentTab.Button, TweenInfo.new(0.3), {TextTransparency = 0.5}):Play()
            
            task.delay(animSpeed, function()
                oldPage.Visible = false
                oldPage.Position = UDim2.new(0, 0, 0, 0) -- Reset position
            end)
        end

        -- 2. Entry Animation (New Menu)
        local newPage = newTab.Page
        
        newPage.Visible = true
        newPage.AnchorPoint = Vector2.new(0, 0)
        newPage.GroupTransparency = 1
        
        -- Start Position: Lawan arah target exit
        -- Jika exit ke atas (-1), entry dari bawah (1)
        newPage.Position = UDim2.new(0, 0, 1 * direction, 0)
        
        -- Tween: Slide to Center (0,0) and Fade In
        local tweenPosIn = TweenService:Create(newPage, tInfo, {Position = UDim2.new(0, 0, 0, 0)})
        local tweenFadeIn = TweenService:Create(newPage, tInfo, {GroupTransparency = 0})
        
        tweenPosIn:Play()
        tweenFadeIn:Play()

        TweenService:Create(newTab.Button, TweenInfo.new(0.3), {TextTransparency = 0}):Play()
        
        CurrentTab = newTab
        
        task.delay(animSpeed, function()
            isAnimating = false
        end)
    end

    local WindowObj = {}

    function WindowObj:AddTab(config)
        local TabName = config.Name
        local TabObj = {}

        -- Tab Button
        local TabBtn = Instance.new("TextButton")
        TabBtn.Name = TabName
        TabBtn.Size = UDim2.new(1, -20, 0, 28) -- Smaller height
        TabBtn.BackgroundTransparency = 1
        TabBtn.Text = ""
        TabBtn.LayoutOrder = #Tabs + 1
        TabBtn.Parent = TabContainer -- Attached to Container, not Sidebar
        
        AddHoverClickAnim(TabBtn)

        local TabText = Instance.new("TextLabel")
        TabText.Size = UDim2.new(1, -30, 1, 0)
        TabText.Position = UDim2.new(0, 30, 0, 0)
        TabText.BackgroundTransparency = 1
        TabText.Text = TabName
        TabText.TextColor3 = Colors.Text
        TabText.TextTransparency = 0.5
        TabText.Font = Enum.Font.GothamSemibold
        TabText.TextSize = 12 -- Smaller text
        TabText.TextXAlignment = Enum.TextXAlignment.Left
        TabText.Parent = TabBtn
        
        if config.Icon then
            local iconId = config.Icon
            if not string.find(iconId, "rbxassetid") then
                if iconId == "player" then iconId = "rbxassetid://3926305904"
                elseif iconId == "next" then iconId = "rbxassetid://3926307971"
                elseif iconId == "scroll" then iconId = "rbxassetid://3926305904"
                end
            end
            
            local TabIcon = Instance.new("ImageLabel")
            TabIcon.Size = UDim2.new(0, 18, 0, 18) -- Smaller icon
            TabIcon.Position = UDim2.new(0, 0, 0.5, -9)
            TabIcon.BackgroundTransparency = 1
            TabIcon.Image = iconId
            TabIcon.ImageColor3 = Colors.Text
            TabIcon.ImageTransparency = 0.5
            TabIcon.Parent = TabBtn
            
            TabObj.Icon = TabIcon
        end

        TabObj.Button = TabText

        -- Tab Page (CanvasGroup for seamless fading)
        local Page = Instance.new("CanvasGroup")
        Page.Name = TabName
        Page.Size = UDim2.new(1, 0, 1, 0)
        Page.BackgroundTransparency = 1
        Page.GroupTransparency = 1 -- Default hidden state
        Page.BorderSizePixel = 0
        Page.Visible = false
        Page.ClipsDescendants = true -- Prevent overflow during rotation
        Page.Parent = ContentContainer

        -- Scale for animation
        local UIScale = Instance.new("UIScale")
        UIScale.Scale = 1
        UIScale.Parent = Page

        -- Scrolling Layout
        local Scroll = Instance.new("ScrollingFrame")
        Scroll.Size = UDim2.new(1, 0, 1, 0)
        Scroll.BackgroundTransparency = 1
        Scroll.ScrollBarThickness = 2
        Scroll.BorderSizePixel = 0
        Scroll.Parent = Page

        local ListLayout = Instance.new("UIListLayout")
        ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
        ListLayout.Padding = UDim.new(0, 10)
        ListLayout.Parent = Scroll
        
        local ListPadding = Instance.new("UIPadding")
        ListPadding.PaddingLeft = UDim.new(0, 5)
        ListPadding.PaddingRight = UDim.new(0, 5)
        ListPadding.PaddingTop = UDim.new(0, 5)
        ListPadding.PaddingBottom = UDim.new(0, 5)
        ListPadding.Parent = Scroll

        ListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            Scroll.CanvasSize = UDim2.new(0, 0, 0, ListLayout.AbsoluteContentSize.Y + 20)
        end)

        TabBtn.MouseButton1Click:Connect(function()
            SwitchTab(TabObj)
        end)

        TabObj.Button = TabBtn
        TabObj.Page = Page
        TabObj.Scroll = Scroll

        -- Section Function (Collapsible / Slide Down)
        function TabObj:AddSection(title)
            -- Main Container for Section
            local SectionContainer = Instance.new("Frame")
            SectionContainer.Name = "Section_" .. title
            SectionContainer.Size = UDim2.new(1, 0, 0, 30) -- Default Collapsed
            SectionContainer.BackgroundTransparency = 1
            SectionContainer.ClipsDescendants = true -- Important for slide effect
            SectionContainer.Parent = Scroll

            -- Header Button
            local HeaderBtn = Instance.new("TextButton")
            HeaderBtn.Name = "Header"
            HeaderBtn.Size = UDim2.new(1, 0, 0, 30)
            HeaderBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
            HeaderBtn.BackgroundTransparency = 0.2
            HeaderBtn.Text = ""
            HeaderBtn.AutoButtonColor = false
            HeaderBtn.Parent = SectionContainer
            
            Instance.new("UICorner", HeaderBtn).CornerRadius = UDim.new(0, 6)
            AddHoverClickAnim(HeaderBtn) -- Animasi klik
            
            local TitleLabel = Instance.new("TextLabel")
            TitleLabel.Size = UDim2.new(1, -35, 1, 0)
            TitleLabel.Position = UDim2.new(0, 10, 0, 0)
            TitleLabel.BackgroundTransparency = 1
            TitleLabel.Text = title
            TitleLabel.TextColor3 = Colors.Text
            TitleLabel.Font = Enum.Font.GothamBold
            TitleLabel.TextSize = 13
            TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
            TitleLabel.Parent = HeaderBtn
            
            local Arrow = Instance.new("TextLabel")
            Arrow.Size = UDim2.new(0, 30, 1, 0)
            Arrow.Position = UDim2.new(1, -30, 0, 0)
            Arrow.BackgroundTransparency = 1
            Arrow.Text = "v"
            Arrow.TextColor3 = Colors.Gradient1
            Arrow.Font = Enum.Font.GothamBold
            Arrow.TextSize = 14
            Arrow.Parent = HeaderBtn

            -- Content Container (Hidden by default)
            local ContentFrame = Instance.new("Frame")
            ContentFrame.Name = "Content"
            ContentFrame.Size = UDim2.new(1, 0, 0, 0)
            ContentFrame.Position = UDim2.new(0, 0, 0, 35) -- Offset dari Header
            ContentFrame.BackgroundTransparency = 1
            ContentFrame.Parent = SectionContainer
            
            local ContentLayout = Instance.new("UIListLayout")
            ContentLayout.SortOrder = Enum.SortOrder.LayoutOrder
            ContentLayout.Padding = UDim.new(0, 5)
            ContentLayout.Parent = ContentFrame
            
            local expanded = false
            
            local function UpdateSize()
                local contentH = ContentLayout.AbsoluteContentSize.Y
                if expanded then
                    local targetH = 30 + 5 + contentH + 5
                    TweenService:Create(SectionContainer, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Size = UDim2.new(1, 0, 0, targetH)}):Play()
                    TweenService:Create(Arrow, TweenInfo.new(0.3), {Rotation = 180}):Play()
                else
                    TweenService:Create(SectionContainer, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Size = UDim2.new(1, 0, 0, 30)}):Play()
                    TweenService:Create(Arrow, TweenInfo.new(0.3), {Rotation = 0}):Play()
                end
            end
            
            HeaderBtn.MouseButton1Click:Connect(function()
                expanded = not expanded
                UpdateSize()
            end)
            
            ContentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                if expanded then UpdateSize() end
            end)
            
            local SectionObj = {}
            
            -- Helper for Container (Modified to attach to ContentFrame)
            local function CreateContainer(height)
                local Frame = Instance.new("Frame")
                Frame.Size = UDim2.new(1, 0, 0, height)
                Frame.BackgroundColor3 = Color3.fromRGB(35, 35, 35) -- Lighter container
                Frame.BackgroundTransparency = 0.3 -- More solid
                Frame.BorderSizePixel = 0
                Frame.Parent = ContentFrame -- Attach to Collapsible Content
                
                local Corner = Instance.new("UICorner")
                Corner.CornerRadius = UDim.new(0, 6)
                Corner.Parent = Frame
                
                local Stroke = Instance.new("UIStroke")
                Stroke.Color = Colors.Gradient1
                Stroke.Transparency = 0.8
                Stroke.Thickness = 1
                Stroke.Parent = Frame
                
                return Frame
            end

            -- Components
            function SectionObj:AddToggle(cfg)
                local Frame = CreateContainer(45) -- Increased Height
                
                local Label = Instance.new("TextLabel")
                Label.Size = UDim2.new(1, -50, 1, 0)
                Label.Position = UDim2.new(0, 10, 0, 0)
                Label.BackgroundTransparency = 1
                Label.Text = cfg.Title
                Label.TextColor3 = Color3.fromRGB(255, 255, 255) -- White Text
                Label.Font = Enum.Font.GothamMedium
                Label.TextSize = 16 -- Larger Text
                Label.TextXAlignment = Enum.TextXAlignment.Left
                Label.Parent = Frame
                
                local ToggleBtn = Instance.new("TextButton")
                ToggleBtn.Size = UDim2.new(0, 24, 0, 24) -- Larger Toggle
                ToggleBtn.Position = UDim2.new(1, -34, 0.5, -12)
                ToggleBtn.BackgroundColor3 = cfg.Default and Colors.Gradient1 or Color3.fromRGB(60, 60, 60) -- Lighter Untoggled
                ToggleBtn.Text = ""
                ToggleBtn.AutoButtonColor = false
                ToggleBtn.Parent = Frame
                
                local TCorner = Instance.new("UICorner")
                TCorner.CornerRadius = UDim.new(0, 4)
                TCorner.Parent = ToggleBtn
                
                local toggled = cfg.Default or false
                
                AddHoverClickAnim(ToggleBtn)

                ToggleBtn.MouseButton1Click:Connect(function()
                    toggled = not toggled
                    TweenService:Create(ToggleBtn, TweenInfo.new(0.2), {
                        BackgroundColor3 = toggled and Colors.Gradient1 or Color3.fromRGB(60, 60, 60)
                    }):Play()
                    if cfg.Callback then cfg.Callback(toggled) end
                end)
                
                if cfg.Default then cfg.Callback(true) end
            end

            function SectionObj:AddButton(cfg)
                local Frame = CreateContainer(45) -- Increased Height
                Frame.BackgroundColor3 = Color3.fromRGB(50, 50, 50) -- Distinct Button Background
                Frame.BackgroundTransparency = 0.2 -- Solid
                
                local Btn = Instance.new("TextButton")
                Btn.Size = UDim2.new(1, 0, 1, 0)
                Btn.BackgroundTransparency = 1
                Btn.Text = cfg.Title
                Btn.TextColor3 = Color3.fromRGB(255, 255, 255) -- White Text
                Btn.Font = Enum.Font.GothamBold -- Bold Text
                Btn.TextSize = 16 -- Larger Text
                Btn.Parent = Frame
                
                AddHoverClickAnim(Btn, Frame)

                Btn.MouseButton1Click:Connect(function()
                    TweenService:Create(Frame, TweenInfo.new(0.1), {BackgroundTransparency = 0.1}):Play() -- Flash brighter
                    task.wait(0.1)
                    TweenService:Create(Frame, TweenInfo.new(0.1), {BackgroundTransparency = 0.2}):Play()
                    if cfg.Callback then cfg.Callback() end
                end)
            end

            function SectionObj:AddInput(cfg)
                local Frame = CreateContainer(50) -- Increased Height
                
                local Label = Instance.new("TextLabel")
                Label.Size = UDim2.new(0.5, -10, 1, 0)
                Label.Position = UDim2.new(0, 10, 0, 0)
                Label.BackgroundTransparency = 1
                Label.Text = cfg.Title
                Label.TextColor3 = Colors.Text
                Label.Font = Enum.Font.GothamMedium
                Label.TextSize = 16 -- Larger
                Label.TextXAlignment = Enum.TextXAlignment.Left
                Label.Parent = Frame
                
                local Input = Instance.new("TextBox")
                Input.Size = UDim2.new(0.4, 0, 0, 30) -- Larger Input Box
                Input.Position = UDim2.new(1, -10, 0.5, 0)
                Input.AnchorPoint = Vector2.new(1, 0.5)
                Input.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
                Input.Text = cfg.Value or ""
                Input.TextColor3 = Colors.Text
                Input.Font = Enum.Font.Gotham
                Input.TextSize = 15 -- Larger Input Text
                Input.Parent = Frame
                
                Instance.new("UICorner", Input).CornerRadius = UDim.new(0, 4)
                
                Input.FocusLost:Connect(function()
                    if cfg.Callback then cfg.Callback(Input.Text) end
                end)
            end

            function SectionObj:AddParagraph(cfg)
                local Frame = CreateContainer(60)
                Frame.BackgroundTransparency = 0.8
                
                local Title = Instance.new("TextLabel")
                Title.Size = UDim2.new(1, -20, 0, 20)
                Title.Position = UDim2.new(0, 10, 0, 5)
                Title.BackgroundTransparency = 1
                Title.Text = cfg.Title
                Title.TextColor3 = Colors.Text
                Title.Font = Enum.Font.GothamBold
                Title.TextSize = 16
                Title.TextXAlignment = Enum.TextXAlignment.Left
                Title.Parent = Frame
                
                local Content = Instance.new("TextLabel")
                Content.Size = UDim2.new(1, -20, 1, -25)
                Content.Position = UDim2.new(0, 10, 0, 25)
                Content.BackgroundTransparency = 1
                Content.Text = cfg.Content
                Content.TextColor3 = Colors.TextDark
                Content.Font = Enum.Font.Gotham
                Content.TextSize = 14
                Content.TextXAlignment = Enum.TextXAlignment.Left
                Content.TextWrapped = true
                Content.TextYAlignment = Enum.TextYAlignment.Top
                Content.Parent = Frame
                
                -- Method to update content
                local ParagraphObj = {
                    Frame = Frame,
                    SetContent = function(self, txt)
                        Content.Text = txt
                    end
                }
                
                return ParagraphObj
            end

            function SectionObj:AddDropdown(cfg)
                local Frame = CreateContainer(45) -- Increased Height
                Frame.ClipsDescendants = true
                
                local Label = Instance.new("TextLabel")
                Label.Size = UDim2.new(1, -40, 0, 45)
                Label.Position = UDim2.new(0, 10, 0, 0)
                Label.BackgroundTransparency = 1
                Label.Text = cfg.Title
                Label.TextColor3 = Colors.Text
                Label.Font = Enum.Font.GothamMedium
                Label.TextSize = 16 -- Larger
                Label.TextXAlignment = Enum.TextXAlignment.Left
                Label.Parent = Frame
                
                local Arrow = Instance.new("TextLabel")
                Arrow.Size = UDim2.new(0, 30, 0, 45)
                Arrow.Position = UDim2.new(1, -30, 0, 0)
                Arrow.BackgroundTransparency = 1
                Arrow.Text = "v"
                Arrow.TextColor3 = Colors.Text
                Arrow.Font = Enum.Font.GothamBold
                Arrow.TextSize = 16
                Arrow.Parent = Frame
                
                local Button = Instance.new("TextButton")
                Button.Size = UDim2.new(1, 0, 0, 45)
                Button.BackgroundTransparency = 1
                Button.Text = ""
                Button.Parent = Frame
                
                AddHoverClickAnim(Button, Frame)

                local expanded = false
                local optionHeight = 30 -- Larger options
                
                Button.MouseButton1Click:Connect(function()
                    expanded = not expanded
                    local count = #cfg.Options
                    local h = expanded and (45 + (count * optionHeight)) or 45
                    TweenService:Create(Frame, TweenInfo.new(0.3), {Size = UDim2.new(1, 0, 0, h)}):Play()
                    Arrow.Rotation = expanded and 180 or 0
                end)
                
                local List = Instance.new("Frame")
                List.Size = UDim2.new(1, -20, 0, #cfg.Options * optionHeight)
                List.Position = UDim2.new(0, 10, 0, 45)
                List.BackgroundTransparency = 1
                List.Parent = Frame
                
                local LL = Instance.new("UIListLayout")
                LL.Parent = List
                
                
                local DropdownObj = {
                    Frame = Frame,
                    SetValues = function(self, newOptions)
                        -- Clear existing
                        for _, child in ipairs(List:GetChildren()) do
                            if child:IsA("TextButton") then child:Destroy() end
                        end
                        
                        -- Add new
                        for _, opt in ipairs(newOptions) do
                            local OptBtn = Instance.new("TextButton")
                            OptBtn.Size = UDim2.new(1, 0, 0, optionHeight)
                            OptBtn.BackgroundTransparency = 1
                            OptBtn.Text = opt
                            OptBtn.TextColor3 = Colors.TextDark
                            OptBtn.Font = Enum.Font.Gotham
                            OptBtn.TextSize = 14
                            OptBtn.TextXAlignment = Enum.TextXAlignment.Left
                            OptBtn.Parent = List
                            
                            OptBtn.MouseButton1Click:Connect(function()
                                if cfg.Multi then
                                    if table.find(selected, opt) then
                                        table.remove(selected, table.find(selected, opt))
                                        OptBtn.TextColor3 = Colors.TextDark
                                    else
                                        table.insert(selected, opt)
                                        OptBtn.TextColor3 = Colors.Gradient1
                                    end
                                    if cfg.Callback then cfg.Callback(selected) end
                                else
                                    Label.Text = cfg.Title .. ": " .. opt
                                    expanded = false
                                    TweenService:Create(Frame, TweenInfo.new(0.3), {Size = UDim2.new(1, 0, 0, 45)}):Play()
                                    Arrow.Rotation = 0
                                    if cfg.Callback then cfg.Callback(opt) end
                                end
                            end)
                        end
                        List.Size = UDim2.new(1, -20, 0, #newOptions * optionHeight)
                    end
                }
                
                -- Initial population
                DropdownObj:SetValues(cfg.Options)
                
                return DropdownObj
            end
            
            function SectionObj:AddSlider(cfg)
                local Frame = CreateContainer(60) -- Increased Height
                
                local Label = Instance.new("TextLabel")
                Label.Size = UDim2.new(1, -20, 0, 20)
                Label.Position = UDim2.new(0, 10, 0, 5)
                Label.BackgroundTransparency = 1
                Label.Text = cfg.Title
                Label.TextColor3 = Colors.Text
                Label.Font = Enum.Font.GothamMedium
                Label.TextSize = 16 -- Larger
                Label.TextXAlignment = Enum.TextXAlignment.Left
                Label.Parent = Frame
                
                local ValueLabel = Instance.new("TextLabel")
                ValueLabel.Size = UDim2.new(0, 50, 0, 20)
                ValueLabel.Position = UDim2.new(1, -60, 0, 5)
                ValueLabel.BackgroundTransparency = 1
                ValueLabel.Text = tostring(cfg.Default or cfg.Min)
                ValueLabel.TextColor3 = Colors.TextDark
                ValueLabel.Font = Enum.Font.Gotham
                ValueLabel.TextSize = 15 -- Larger
                ValueLabel.TextXAlignment = Enum.TextXAlignment.Right
                ValueLabel.Parent = Frame
                
                local SliderBar = Instance.new("Frame")
                SliderBar.Size = UDim2.new(1, -20, 0, 8) -- Thicker bar
                SliderBar.Position = UDim2.new(0, 10, 0, 40) -- Lower position
                SliderBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                SliderBar.BorderSizePixel = 0
                SliderBar.Parent = Frame
                
                Instance.new("UICorner", SliderBar).CornerRadius = UDim.new(0, 3)
                
                local Fill = Instance.new("Frame")
                Fill.Size = UDim2.new(0, 0, 1, 0)
                Fill.BackgroundColor3 = Colors.Gradient1
                Fill.BorderSizePixel = 0
                Fill.Parent = SliderBar
                
                Instance.new("UICorner", Fill).CornerRadius = UDim.new(0, 3)
                
                local Trigger = Instance.new("TextButton")
                Trigger.Size = UDim2.new(1, 0, 1, 0)
                Trigger.BackgroundTransparency = 1
                Trigger.Text = ""
                Trigger.Parent = SliderBar
                
                local min, max = cfg.Min, cfg.Max
                local def = cfg.Default or min
                
                local function Update(input)
                    local pos = math.clamp((input.Position.X - SliderBar.AbsolutePosition.X) / SliderBar.AbsoluteSize.X, 0, 1)
                    local val = math.floor(min + (max - min) * pos)
                    Fill.Size = UDim2.new(pos, 0, 1, 0)
                    ValueLabel.Text = tostring(val)
                    if cfg.Callback then cfg.Callback(val) end
                end
                
                local dragging = false
                Trigger.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                        dragging = true
                        Update(input)
                    end
                end)
                
                Services.UserInputService.InputChanged:Connect(function(input)
                    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                        Update(input)
                    end
                end)
                
                Services.UserInputService.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                        dragging = false
                    end
                end)
                
                -- Init
                local percent = (def - min) / (max - min)
                Fill.Size = UDim2.new(percent, 0, 1, 0)
                ValueLabel.Text = tostring(def)
            end

            return SectionObj
        end

        table.insert(Tabs, TabObj)
        if #Tabs == 1 then
            SwitchTab(TabObj)
        end
        return TabObj
    end
    
    return WindowObj, ScreenGui
end

-- Create Window
local Window, ScreenGui = UI:CreateWindow("DanuHub Luxury")

-- ==================== DISABLE ALL FEATURES FUNCTION ====================
local function DisableAllFeatures()
    State.autoEquipRod = false
    State.autoInstant = false
    State.supportEnabled = false
    State.autoSellEnabled = false
    State.autoFavEnabled = false
    State.autoDeepSea = false
    State.autoElement = false
    State.autoArtifact = false
    State.trade.trading = false
    State.frozen = false
    State.autoEventActive = false
    
    _G.LegitFishing = false
    _G.AutoShake = false
    _G.FBlatant = false
    _G.ThresholdFarm = false
    _G.CoinFarm = false
    _G.EnchantFarm = false
    _G.AutoPotion = false
    _G.AutoAccept = false
    _G.AntiStaff = false
    _G.DelEffects = false
    _G.IrRod = false
    _G.WebhookFlags.FishCaught.Enabled = false
    _G.WebhookFlags.Stats.Enabled = false
    
    SetupWalkOnWater(false)
    pcall(function()
        local char = GetCharacter()
        for _, p in ipairs(char:GetDescendants()) do 
            if p:IsA("BasePart") then p.Anchored = false end 
        end
    end)
    Notify("All features disabled!")
end

-- ==================== MINI TOGGLE BUTTON (UPDATED THEME) ====================
local ToggleGui = Instance.new("ScreenGui")
ToggleGui.Name = "DanuHub_Toggle"
ToggleGui.ResetOnSpawn = false
ToggleGui.DisplayOrder = 999
pcall(function() ToggleGui.Parent = Services.CoreGui end)
if not ToggleGui.Parent then ToggleGui.Parent = PlayerGui end

local ToggleBtn = Instance.new("ImageButton")
ToggleBtn.Name = "MiniToggle"
ToggleBtn.Size = UDim2.new(0, 50, 0, 50)
ToggleBtn.Position = UDim2.new(0.5, 0, 0.5, 0)
ToggleBtn.AnchorPoint = Vector2.new(0.5, 0.5)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(80, 0, 120) -- Purple
ToggleBtn.BorderSizePixel = 0
ToggleBtn.AutoButtonColor = false
ToggleBtn.Image = "rbxassetid://79215279738637"
ToggleBtn.ScaleType = Enum.ScaleType.Fit
ToggleBtn.Visible = false
ToggleBtn.Parent = ToggleGui

local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 12)
Corner.Parent = ToggleBtn

local Stroke = Instance.new("UIStroke")
Stroke.Color = Color3.fromRGB(255, 255, 255)
Stroke.Thickness = 2
Stroke.Parent = ToggleBtn

local MainFrame = ScreenGui:FindFirstChild("MainFrame")

local function ShowToggleButton()
    ToggleBtn.Visible = true
    ToggleBtn.BackgroundTransparency = 1
    TweenService:Create(ToggleBtn, TweenInfo.new(0.5), {BackgroundTransparency = 0}):Play()
end

local function HideToggleButton()
    local t = TweenService:Create(ToggleBtn, TweenInfo.new(0.5), {BackgroundTransparency = 1})
    t:Play()
    t.Completed:Connect(function() ToggleBtn.Visible = false end)
end

ToggleBtn.MouseButton1Click:Connect(function()
    if MainFrame then
        MainFrame.Visible = true
        HideToggleButton()
    end
end)

Services.UserInputService.InputBegan:Connect(function(input, gpe)
    if not gpe and (input.KeyCode == Enum.KeyCode.RightControl or input.KeyCode == Enum.KeyCode.Home) then
        if MainFrame then
            if MainFrame.Visible then
                MainFrame.Visible = false
                ShowToggleButton()
            else
                MainFrame.Visible = true
                HideToggleButton()
            end
        end
    end
end)

-- ==================== UI CONSTRUCTION ====================

-- 1. INFO TAB
local InfoTab = Window:AddTab({ Name = "Info", Icon = "rbxassetid://7733960981" })
local InfoSec = InfoTab:AddSection("Welcome")
InfoSec:AddParagraph({ Title = "About", Content = "DanuHub Luxury v2.2\nRedesigned with Gradient Theme\nSmooth Animations" })

InfoSec:AddButton({ Title = "Join Discord Community", Callback = function()
    if setclipboard then setclipboard("https://discord.gg/VBbh4deB") end
    Notify("Discord link copied to clipboard!")
end })

InfoSec:AddButton({ Title = "Visit TikTok Creator", Callback = function()
    if setclipboard then setclipboard("https://www.tiktok.com/@pemoedakinyis?is_from_webapp=1&sender_device=pc") end
    Notify("TikTok link copied to clipboard!")
end })

-- 2. MAIN TAB (FISHING)
local MainTab = Window:AddTab({ Name = "Fishing", Icon = "rbxassetid://97167558235554" })
local FishSup = MainTab:AddSection("Fishing Support")

FishSup:AddToggle({ Title = "Auto Equip Rod", Default = State.autoEquipRod, Callback = function(v)
    State.autoEquipRod = v
    if v then task.spawn(function() while State.autoEquipRod do
        pcall(function() SafeFireServer("RE/EquipToolFromHotbar", 1) end)
        task.wait(1)
    end end) end
end })

FishSup:AddToggle({ Title = "Walk on Water", Default = false, Callback = function(v) SetupWalkOnWater(v) end })

FishSup:AddToggle({ Title = "Freeze Player", Default = State.frozen, Callback = function(v)
    State.frozen = v
    local char = GetCharacter()
    for _, p in ipairs(char:GetDescendants()) do if p:IsA("BasePart") then p.Anchored = v end end
end })

-- Detector
local FishFeat = MainTab:AddSection("Features")
local DetectorPara = FishFeat:AddParagraph({ Title = "Detector Status", Content = "Idle" })

FishFeat:AddSlider({ Title = "Stuck Threshold (s)", Min = 10, Max = 60, Default = 15, Callback = function(v) State.stuckThreshold = v end })

FishFeat:AddToggle({ Title = "Start Detector", Default = false, Callback = function(v)
    State.supportEnabled = v
    if v then
        local hrp = GetHRP()
        if hrp then State.savedCFrame = hrp.CFrame end
        _G.Celestial.DetectorCount = GetFishCount()
        State.fishingTimer = 0
        
        task.spawn(function()
            local lastTick = tick()
            while State.supportEnabled do
                task.wait(0.2)
                local count = GetFishCount()
                State.fishingTimer = State.fishingTimer + (tick() - lastTick)
                lastTick = tick()
                if count ~= _G.Celestial.DetectorCount then _G.Celestial.DetectorCount = count; State.fishingTimer = 0 end
                if State.fishingTimer >= State.stuckThreshold then
                    DetectorPara:SetContent("Resetting...")
                    local h = GetHRP(); if h then State.savedCFrame = h.CFrame end
                    LocalPlayer.Character:BreakJoints()
                    local nc = LocalPlayer.CharacterAdded:Wait(); task.wait(0.3)
                    local nh = nc:WaitForChild("HumanoidRootPart", 5); if nh and State.savedCFrame then nh.CFrame = State.savedCFrame end
                    _G.Celestial.DetectorCount = GetFishCount(); State.fishingTimer = 0
                else
                    DetectorPara:SetContent(string.format("Running | Time: %.1fs | Bag: %d", State.fishingTimer, count))
                end
            end
            DetectorPara:SetContent("Offline")
        end)
    else DetectorPara:SetContent("Offline") end
end })

FishFeat:AddToggle({ Title = "Legit Fishing (Tap + Shake)", Default = _G.LegitFishing, Callback = function(v)
    _G.LegitFishing = v
    pcall(function()
        local clickEffect = PlayerGui:FindFirstChild("!!! Click Effect")
        if clickEffect then clickEffect.Enabled = not v end
    end)
    if v then 
        task.spawn(function() 
            while _G.LegitFishing do
                if CosmeticFolder and CosmeticFolder:FindFirstChild(userId) then
                    CastWithBarRelease()
                    task.wait(0.2)
                else
                    task.wait(0.2)
                end
            end 
        end)
        task.spawn(function() 
            while _G.LegitFishing do DoAutoShake(); task.wait(0.1) end 
        end)
    else
        pcall(function()
            local clickEffect = PlayerGui:FindFirstChild("!!! Click Effect")
            if clickEffect then clickEffect.Enabled = true end
        end)
    end
end })

-- Instant
local InstSec = MainTab:AddSection("Instant")
InstSec:AddInput({ Title = "Delay Complete", Value = tostring(_G.DelayComplete), Callback = function(v) _G.DelayComplete = tonumber(v) or 0.5 end })
InstSec:AddToggle({ Title = "Instant Fishing", Default = State.autoInstant, Callback = function(v)
    State.autoInstant = v
    if v then 
        _G.Celestial.InstantCount = GetFishCount()
        task.spawn(function() 
            while State.autoInstant do InstantFishing(); task.wait(0.1) end 
        end) 
    end
end })

-- Blatant
local BlatSec = MainTab:AddSection("Blatant")
BlatSec:AddInput({ Title = "Delay Reel", Value = tostring(_G.Reel), Callback = function(v) _G.Reel = tonumber(v) or 1.9 end })
BlatSec:AddInput({ Title = "Delay Fishing", Value = tostring(_G.FishingDelay), Callback = function(v) _G.FishingDelay = tonumber(v) or 1.1 end })
BlatSec:AddToggle({ Title = "Blatant Fishing", Default = _G.FBlatant, Callback = function(v)
    _G.FBlatant = v
    SafeInvokeServer("RF/UpdateAutoFishingState", v)
    if v then 
        LocalPlayer:SetAttribute("Loading", nil)
        task.spawn(function() while _G.FBlatant do FastestFishing(); task.wait(_G.Reel) end end)
    else LocalPlayer:SetAttribute("Loading", false) end
end })
BlatSec:AddButton({ Title = "Recovery Fishing", Callback = function() CancelFishing(); Notify("Recovery!") end })

-- Selling
local SellSec = MainTab:AddSection("Selling")
SellSec:AddDropdown({ Title = "Sell Mode", Options = {"Delay", "Count"}, Callback = function(v) State.sellMode = v end })
SellSec:AddInput({ Title = "Value (min/count)", Value = "1", Callback = function(v) 
    local n = tonumber(v) or 1
    if State.sellMode == "Delay" then State.sellDelay = n * 60 else State.inputSellCount = n end 
end })
SellSec:AddToggle({ Title = "Auto Sell", Default = State.autoSellEnabled, Callback = function(v)
    State.autoSellEnabled = v
    if v then task.spawn(function() 
        while State.autoSellEnabled do
            if State.sellMode == "Delay" then task.wait(State.sellDelay); SafeInvokeServer("RF/SellAllItems")
            else if GetFishCount() >= State.inputSellCount then SafeInvokeServer("RF/SellAllItems") end; task.wait(1) end
        end 
    end) end
end })

-- 3. AUTO TAB
local AutoTab = Window:AddTab({ Name = "Auto", Icon = "rbxassetid://7733954760" })
local ShopSec = AutoTab:AddSection("Shop")
local ShopPara = ShopSec:AddParagraph({ Title = "Merchant", Content = "Loading..." })

-- Merchant Updater
task.spawn(function()
    while true do
        task.wait(1)
        pcall(function()
            local merchant = PlayerGui:FindFirstChild("Merchant")
            if merchant and merchant:FindFirstChild("Main") then
                 ShopPara:SetContent("Merchant GUI Detected")
            else
                 ShopPara:SetContent("No Merchant GUI")
            end
        end)
    end
end)

ShopSec:AddButton({ Title = "Open/Close Merchant", Callback = function()
    local m = PlayerGui:FindFirstChild("Merchant")
    if m then m.Enabled = not m.Enabled end
end })

ShopSec:AddDropdown({ Title = "Select Rod", Options = #State.rodDisplayNames > 0 and State.rodDisplayNames or {"No Rods"}, Callback = function(v) 
    local r = State.rods[CleanName(v)]; if r then State.selectedRodId = r.Id end 
end })
ShopSec:AddButton({ Title = "Buy Rod", Callback = function() if State.selectedRodId then SafeInvokeServer("RF/PurchaseFishingRod", State.selectedRodId) end end })

ShopSec:AddDropdown({ Title = "Select Bait", Options = #State.baitDisplayNames > 0 and State.baitDisplayNames or {"No Baits"}, Callback = function(v) 
    local b = State.baits[CleanName(v)]; if b then State.selectedBaitId = b.Id end 
end })
ShopSec:AddButton({ Title = "Buy Bait", Callback = function() if State.selectedBaitId then SafeInvokeServer("RF/PurchaseBait", State.selectedBaitId) end end })

-- 4. TRADE TAB
local TradeTab = Window:AddTab({ Name = "Trade", Icon = "rbxassetid://114581487428395" })
local TradeSec = TradeTab:AddSection("Trade System")
TradeSec:AddInput({ Title = "Target Player", Value = "", Callback = function(v) State.trade.selectedPlayer = v end })
TradeSec:AddDropdown({ Title = "Select Item Type", Options = {"Fish", "Bait", "Item"}, Callback = function(v) 
    -- Would need to implement list refresh logic here in a full rewrite, keeping simple for now
end })
TradeSec:AddButton({ Title = "Refresh Inventory", Callback = function() Notify("Refreshed") end })

-- (Teleport & Webhook Tabs moved to bottom to avoid duplication)
-- Notify("DanuHub Luxury Loaded!") -- Moved to end

-- Enchant - FIXED
local EnchantSec = AutoTab:AddSection("Enchant Features")
local EnchantPara = EnchantSec:AddParagraph({ Title = "Enchant Status", Content = "Current Rod: None\nCurrent Enchant: None\nEnchant Stones: 0" })

local function UpdateEnchantStatus()
    local rod, enchant, stones = GetEnchantInfo(10)
    EnchantPara:SetContent(string.format("Current Rod: %s\nCurrent Enchant: %s\nEnchant Stones: %d", rod, enchant, stones))
end

task.spawn(function()
    while true do
        task.wait(2)
        pcall(UpdateEnchantStatus)
    end
end)

EnchantSec:AddButton({ Title = "Click Enchant", Callback = function() 
    SafeFireServer("RE/ActivateEnchantingAltar")
    task.wait(1)
    UpdateEnchantStatus()
    Notify("Enchant clicked!") 
end })
EnchantSec:AddButton({ Title = "TP Enchant Altar", Callback = function() Teleport(Vector3.new(3258, -1301, 1391)) end })
EnchantSec:AddButton({ Title = "Click Double Enchant", Callback = function() 
    SafeFireServer("RE/ActivateSecondEnchantingAltar")
    task.wait(1)
    UpdateEnchantStatus()
    Notify("Double Enchant clicked!") 
end })
EnchantSec:AddButton({ Title = "TP Second Altar", Callback = function() Teleport(Vector3.new(1480, 128, -593)) end })

-- Totem - FIXED
local TotemSec = AutoTab:AddSection("Totem Features")
local TotemPara = TotemSec:AddParagraph({ Title = "Active Totems", Content = "Scanning..." })

local function UpdateTotemPanel()
    local totems = GetTotemInfo()
    if #totems == 0 then
        TotemPara:SetContent("No active totems detected.")
    else
        local lines = {}
        for _, t in ipairs(totems) do
            table.insert(lines, string.format("%s  %.1f studs  %s", t.Name, t.Distance, t.TimeLeft))
        end
        TotemPara:SetContent(table.concat(lines, "\n"))
    end
end

task.spawn(function()
    while true do
        task.wait(1)
        pcall(UpdateTotemPanel)
    end
end)

TotemSec:AddButton({ Title = "TP to Nearest Totem", Callback = function()
    local totems = GetTotemInfo()
    if #totems == 0 then Notify("No totems found"); return end
    
    table.sort(totems, function(a, b) return a.Distance < b.Distance end)
    
    local totemsFolder = workspace:FindFirstChild("Totems")
    if totemsFolder then
        local hrp = GetHRP()
        for _, totem in ipairs(totemsFolder:GetChildren()) do
            if totem:IsA("Model") then
                local dist = (totem:GetPivot().Position - hrp.Position).Magnitude
                if math.abs(dist - totems[1].Distance) < 1 then
                    hrp.CFrame = CFrame.new(totem:GetPivot().Position + Vector3.new(0, 3, 0))
                    break
                end
            end
        end
    end
end })

local selectedTotem = nil
TotemSec:AddDropdown({ Title = "Select Totem", Options = #State.TotemDisplayName > 0 and State.TotemDisplayName or {"No Totems"}, Callback = function(v) selectedTotem = v end })
TotemSec:AddButton({ Title = "Spawn Totem", Callback = function()
    if selectedTotem and State.Totems[selectedTotem] then
        SafeFireServer("RE/SpawnTotem", State.Totems[selectedTotem].Id)
        Notify("Spawned " .. selectedTotem)
    end
end })

-- Potion
local PotionSec = AutoTab:AddSection("Potion Features")
local selectedPotions = {}
PotionSec:AddDropdown({ Title = "Select Potions", Multi = true, Options = #State.PotionDisplayName > 0 and State.PotionDisplayName or {"No Potions"}, Callback = function(v) selectedPotions = v end })

PotionSec:AddToggle({ Title = "Auto Use Potions", Default = false, Callback = function(v)
    _G.AutoPotion = v
    if v then task.spawn(function() 
        while _G.AutoPotion do
            pcall(function()
                for _, potName in ipairs(selectedPotions) do
                    local potId = State.Potions[potName] and State.Potions[potName].Id
                    if potId then
                        SafeInvokeServer("RF/ConsumePotion", potId)
                    end
                end
            end)
            task.wait(2)
        end 
    end) end
end })
-- Event Features - FIXED
local EventSec = AutoTab:AddSection("Event Features")
local EventDropdown = EventSec:AddDropdown({ 
    Title = "Priority Event", 
    Options = GetActiveEvents(), 
    Callback = function(v) State.priorityEvent = v end 
})

EventSec:AddButton({ Title = "Refresh Events", Callback = function()
    -- Need to implement SetValues in the library for full functionality
    -- For now we just re-scan
    local events = GetActiveEvents()
    -- Simulating refresh by notifying
    Notify("Events Refreshed: " .. #events)
end })

EventSec:AddToggle({ Title = "Auto Event", Default = false, Callback = function(v)
    State.autoEventActive = v
    if v then
        local hrp = GetHRP()
        if hrp then State.origCF = hrp.CFrame end
        
        task.spawn(function()
            while State.autoEventActive do
                local eventPart = nil
                local eventName = nil
                
                if State.priorityEvent then
                    eventPart = FindEventPart(State.priorityEvent)
                    if eventPart then eventName = State.priorityEvent end
                end
                
                if not eventPart and #State.selectedEvents > 0 then
                    for _, ev in ipairs(State.selectedEvents) do
                        eventPart = FindEventPart(ev)
                        if eventPart then
                            eventName = ev
                            break
                        end
                    end
                end
                
                if eventPart then
                    local h = GetHRP()
                    if h then
                        local targetPos = eventPart.CFrame + Vector3.new(0, 7, 0)
                        if (h.Position - eventPart.Position).Magnitude > 40 then
                            h.CFrame = targetPos
                            State.curCF = targetPos
                            Notify("Event! " .. eventName)
                        end
                    end
                elseif State.curCF and State.origCF then
                    local h = GetHRP()
                    if h then
                        h.CFrame = State.origCF
                        Notify("Event ended -> Back")
                    end
                    State.curCF = nil
                end
                
                task.wait(0.5)
            end
            
            if State.origCF then
                local h = GetHRP()
                if h then h.CFrame = State.origCF end
            end
            State.curCF = nil
            State.origCF = nil
        end)
    end
end })

-- Save Position
local SaveSec = AutoTab:AddSection("Save Position")
SaveSec:AddButton({ Title = "Save Position", Callback = function()
    local hrp = GetHRP(); if hrp then SavePosition(hrp.CFrame); Notify("Saved!") end
end })
SaveSec:AddButton({ Title = "Reset Saved Position", Callback = function()
    if isfile and isfile(PositionPath) then delfile(PositionPath) end; Notify("Reset!")
end })

-- ==================== TRADE TAB ====================
local TradeFishSec = TradeTab:AddSection("Trade Fish by Name")
local TradePara = TradeFishSec:AddParagraph({ Title = "Trade Status", Content = "Player: ???\nItem: ???\nStatus: Idle" })
-- Note: Dropdown updates need Library support for SetValues.
-- For this version, we rely on static options or re-opening GUI.

local function UpdateTradePanel()
    local t = State.trade
    local status = t.trading and "Trading..." or "Idle"
    TradePara:SetContent(string.format("Player: %s\nItem: %s\nAmount: %d\nStatus: %s\nSuccess: %d / %d",
        t.selectedPlayer or "???",
        t.selectedItem or "???",
        t.tradeAmount or 0,
        status,
        t.successCount or 0,
        t.totalToTrade or 0
    ))
end

TradeFishSec:AddButton({ Title = "Refresh Fish List", Callback = function()
    local g, d = GetGroupedByType("Fish"); State.trade.currentGrouped = g
    Notify("Found " .. #d .. " fish types")
end })

TradeFishSec:AddInput({ Title = "Item Name (Exact)", Value = "", Callback = function(v)
    State.trade.selectedItem = v
    UpdateTradePanel()
end })

TradeFishSec:AddInput({ Title = "Player Name (Partial)", Value = "", Callback = function(v)
    -- Simple partial match
    for _, p in ipairs(Services.Players:GetPlayers()) do
        if p.Name:lower():match(v:lower()) or p.DisplayName:lower():match(v:lower()) then
            State.trade.selectedPlayer = p.Name
            break
        end
    end
    UpdateTradePanel()
end })

TradeFishSec:AddInput({ Title = "Amount", Value = "1", Callback = function(v) 
    State.trade.tradeAmount = tonumber(v) or 1 
    UpdateTradePanel()
end })

TradeFishSec:AddToggle({ Title = "Start Trading", Default = false, Callback = function(v)
    if v then
        if not State.trade.selectedPlayer or not State.trade.selectedItem then 
            Notify("Select player & item!") 
            return 
        end
        State.trade.trading = true
        State.trade.successCount = 0
        
        -- Get grouped data freshly if not set
        if not State.trade.currentGrouped or not State.trade.currentGrouped[State.trade.selectedItem] then
             local g, _ = GetGroupedByType("Fish")
             State.trade.currentGrouped = g
        end

        local data = State.trade.currentGrouped[State.trade.selectedItem]
        if not data then 
            Notify("Item not found in inventory")
            State.trade.trading = false
            return 
        end
        State.trade.totalToTrade = math.min(State.trade.tradeAmount, #data.uuids)
        UpdateTradePanel()
        
        task.spawn(function()
            local i = 1
            while State.trade.trading and State.trade.successCount < State.trade.totalToTrade do
                if i > #data.uuids then break end
                if ExecuteTrade(State.trade.selectedPlayer, data.uuids[i], State.trade.selectedItem) then
                    State.trade.successCount = State.trade.successCount + 1
                    UpdateTradePanel()
                end
                i = i + 1
                task.wait(2)
            end
            State.trade.trading = false
            UpdateTradePanel()
            Notify("Trading finished! Sent: " .. State.trade.successCount)
        end)
    else 
        State.trade.trading = false 
        UpdateTradePanel()
    end
end })

-- Trade by Rarity
local TradeRaritySec = TradeTab:AddSection("Trade by Rarity")
local RarityPara = TradeRaritySec:AddParagraph({ Title = "Rarity Trade Status", Content = "Idle" })

TradeRaritySec:AddDropdown({ Options = {"Common","Uncommon","Rare","Epic","Legendary","Mythic","Secret"}, Title = "Select Rarity", Callback = function(v)
    State.trade.selectedRarity = v
end })
TradeRaritySec:AddInput({ Title = "Amount", Value = "1", Callback = function(v) State.trade.rarityAmount = tonumber(v) or 1 end })

TradeRaritySec:AddToggle({ Title = "Start Rarity Trade", Default = false, Callback = function(v)
    if v then
        if not State.trade.selectedPlayer or not State.trade.selectedRarity then 
            Notify("Select player & rarity!") 
            return 
        end
        State.trade.trading = true
        
        task.spawn(function()
            local g, _ = GetGroupedByRarity(State.trade.selectedRarity)
            local sent = 0
            
            for name, data in pairs(g) do
                if not State.trade.trading then break end
                for i = 1, math.min(State.trade.rarityAmount, #data.uuids) do
                    if not State.trade.trading then break end
                    if ExecuteTrade(State.trade.selectedPlayer, data.uuids[i], name) then 
                        sent = sent + 1 
                        RarityPara:SetContent(string.format("Progress: %d sent", sent))
                    end
                    task.wait(2)
                end
            end
            
            State.trade.trading = false
            RarityPara:SetContent("Finished! Sent: " .. sent)
            Notify("Rarity trade done! Sent: " .. sent)
        end)
    else 
        State.trade.trading = false 
        RarityPara:SetContent("Idle")
    end
end })

-- Auto Accept
local AcceptSec = TradeTab:AddSection("Auto Accept")
AcceptSec:AddToggle({ Title = "Auto Accept Trade", Default = false, Callback = function(v) _G.AutoAccept = v end })

task.spawn(function() 
    while true do 
        task.wait(1)
        if _G.AutoAccept then 
            pcall(function()
                local prompt = PlayerGui:FindFirstChild("Prompt")
                if prompt then
                    local blackout = prompt:FindFirstChild("Blackout")
                    if blackout then
                        local options = blackout:FindFirstChild("Options")
                        if options then
                            local yes = options:FindFirstChild("Yes")
                            if yes then
                                Services.VIM:SendMouseButtonEvent(
                                    yes.AbsolutePosition.X + yes.AbsoluteSize.X/2, 
                                    yes.AbsolutePosition.Y + yes.AbsoluteSize.Y/2 + 50, 
                                    0, true, game, 1
                                )
                                task.wait(0.03)
                                Services.VIM:SendMouseButtonEvent(
                                    yes.AbsolutePosition.X + yes.AbsoluteSize.X/2, 
                                    yes.AbsolutePosition.Y + yes.AbsoluteSize.Y/2 + 50, 
                                    0, false, game, 1
                                )
                            end
                        end
                    end
                end
            end) 
        end 
    end 
end)

-- ==================== FARM TAB ====================
local FarmTab = Window:AddTab({ Name = "Farm", Icon = "rbxassetid://140165584241571" })
-- Threshold Farm - FIXED
local ThresholdSec = FarmTab:AddSection("Threshold Farm")
local ThresholdPara = ThresholdSec:AddParagraph({ Title = "Progress", Content = "Current: 0\nTarget: 0\nProgress: 0%" })
local ThresholdBase, ThresholdTarget = 0, 0
local ThresholdPos1, ThresholdPos2 = "", ""

ThresholdSec:AddInput({ Title = "Position 1 (x,y,z)", Value = "", Callback = function(v) ThresholdPos1 = v end })
ThresholdSec:AddInput({ Title = "Position 2 (x,y,z)", Value = "", Callback = function(v) ThresholdPos2 = v end })
ThresholdSec:AddInput({ Title = "Target Fish", Value = "100", Callback = function(v) ThresholdTarget = tonumber(v) or 100 end })
ThresholdSec:AddButton({ Title = "Copy Current Position", Callback = function()
    local hrp = GetHRP()
    if hrp and setclipboard then 
        setclipboard(string.format("%.1f,%.1f,%.1f", hrp.Position.X, hrp.Position.Y, hrp.Position.Z))
        Notify("Copied!") 
    end
end })

ThresholdSec:AddToggle({ Title = "Enable Threshold Farm", Default = false, Callback = function(v)
    _G.ThresholdFarm = v
    if v then
        pcall(function()
            local stats = Data:Get({"Statistics"})
            if stats and stats.FishCaught then ThresholdBase = stats.FishCaught end
        end)
        
        task.spawn(function()
            local savedPos = nil
            local hrp = GetHRP()
            if hrp then savedPos = hrp.CFrame end
            
            while _G.ThresholdFarm do
                task.wait(1)
                pcall(function()
                    local stats = Data:Get({"Statistics"})
                    if stats and stats.FishCaught then
                        local current = stats.FishCaught - ThresholdBase
                        local progress = ThresholdTarget > 0 and math.min((current / ThresholdTarget) * 100, 100) or 0
                        ThresholdPara:SetContent(string.format("Current: %d\nTarget: %d\nProgress: %.1f%%", current, ThresholdTarget, progress))
                        
                        if current >= ThresholdTarget and ThresholdPos1 ~= "" and ThresholdPos2 ~= "" then
                            local parts1 = string.split(ThresholdPos1, ",")
                            local parts2 = string.split(ThresholdPos2, ",")
                            local pos1 = Vector3.new(tonumber(parts1[1]) or 0, tonumber(parts1[2]) or 0, tonumber(parts1[3]) or 0)
                            local pos2 = Vector3.new(tonumber(parts2[1]) or 0, tonumber(parts2[2]) or 0, tonumber(parts2[3]) or 0)
                            
                            Teleport(pos2)
                            ThresholdBase = stats.FishCaught
                            task.wait(2)
                            Teleport(pos1)
                        end
                    end
                end)
            end
        end)
    end
end })

-- Coin Farm - FIXED
local CoinSec = FarmTab:AddSection("Coin Farm")
local CoinPara = CoinSec:AddParagraph({ Title = "Progress", Content = "Current: 0\nTarget: 0\nProgress: 0%" })
local CoinBase, CoinTarget = 0, 0
local CoinSpotOptions = { ["Kohana Volcano"] = Vector3.new(-552, 19, 183), ["Tropical Grove"] = Vector3.new(-2084, 3, 3700) }
local SelectedCoinSpot = nil

CoinSec:AddDropdown({ Title = "Location", Options = {"Kohana Volcano", "Tropical Grove"}, Callback = function(v) SelectedCoinSpot = CoinSpotOptions[v] end })
CoinSec:AddInput({ Title = "Target Coin", Value = "10000", Callback = function(v) CoinTarget = tonumber(v) or 10000 end })

CoinSec:AddToggle({ Title = "Enable Coin Farm", Default = false, Callback = function(v)
    _G.CoinFarm = v
    if v then
        pcall(function() CoinBase = Data:Get({"Coins"}) or 0 end)
        local savedPos = nil
        local hrp = GetHRP()
        if hrp then savedPos = hrp.CFrame end
        
        task.spawn(function()
            while _G.CoinFarm do
                task.wait(1)
                pcall(function()
                    local coins = Data:Get({"Coins"}) or 0
                    local progress = coins - CoinBase
                    local percent = CoinTarget > 0 and math.min((progress / CoinTarget) * 100, 100) or 0
                    CoinPara:SetContent(string.format("Current: %d\nTarget: %d\nProgress: %.1f%%", progress, CoinTarget, percent))
                    
                    if progress >= CoinTarget then
                        if savedPos then Teleport(savedPos) end
                        _G.CoinFarm = false
                        Notify("Coin farm complete!")
                    elseif SelectedCoinSpot then
                        local h = GetHRP()
                        if h and (h.Position - SelectedCoinSpot).Magnitude > 10 then
                            Teleport(SelectedCoinSpot)
                        end
                    end
                end)
            end
        end)
    end
end })

-- Enchant Stone Farm - FIXED
local EStoneSec = FarmTab:AddSection("Enchant Stone Farm")
local EStonePara = EStoneSec:AddParagraph({ Title = "Progress", Content = "Current: 0\nTarget: 0\nProgress: 0%" })
local EStoneBase, EStoneTarget = 0, 0
local EStoneSpotOptions = { ["Tropical Grove"] = Vector3.new(-2084, 3, 3700), ["Esoteric Depths"] = Vector3.new(3272, -1302, 1404) }
local SelectedEStoneSpot = nil

EStoneSec:AddDropdown({ Title = "Location", Options = {"Tropical Grove", "Esoteric Depths"}, Callback = function(v) SelectedEStoneSpot = EStoneSpotOptions[v] end })
EStoneSec:AddInput({ Title = "Target Stones", Value = "10", Callback = function(v) EStoneTarget = tonumber(v) or 10 end })

EStoneSec:AddToggle({ Title = "Enable Enchant Farm", Default = false, Callback = function(v)
    _G.EnchantFarm = v
    if v then
        EStoneBase = 0
        pcall(function()
            local items = Data:Get({"Inventory", "Items"}) or {}
            for _, item in ipairs(items) do 
                if item.Id == 10 then 
                    EStoneBase = EStoneBase + (item.Amount or 1) 
                end 
            end
        end)
        
        local savedPos = nil
        local hrp = GetHRP()
        if hrp then savedPos = hrp.CFrame end
        
        task.spawn(function()
            while _G.EnchantFarm do
                task.wait(1)
                pcall(function()
                    local count = 0
                    local items = Data:Get({"Inventory", "Items"}) or {}
                    for _, item in ipairs(items) do 
                        if item.Id == 10 then 
                            count = count + (item.Amount or 1) 
                        end 
                    end
                    
                    local progress = count - EStoneBase
                    local percent = EStoneTarget > 0 and math.min((progress / EStoneTarget) * 100, 100) or 0
                    EStonePara:SetContent(string.format("Current: %d\nTarget: %d\nProgress: %.1f%%", progress, EStoneTarget, percent))
                    
                    if progress >= EStoneTarget then
                        if savedPos then Teleport(savedPos) end
                        _G.EnchantFarm = false
                        Notify("Enchant stone farm complete!")
                    elseif SelectedEStoneSpot then
                        local h = GetHRP()
                        if h and (h.Position - SelectedEStoneSpot).Magnitude > 10 then
                            Teleport(SelectedEStoneSpot)
                        end
                    end
                end)
            end
        end)
    end
end })

-- ==================== QUEST TAB ====================
local QuestTab = Window:AddTab({ Name = "Quest", Icon = "rbxassetid://7733920644" })
-- Artifact - FIXED
local ArtifactSec = QuestTab:AddSection("Artifact Quest")
local ArtifactPara = ArtifactSec:AddParagraph({ Title = "Artifact Status", Content = "Loading..." })

local function FormatArtifactStatus(name, active)
    local shortName = name:gsub(" Artifact", "")
    local color = active and "0,255,0" or "255,0,0"
    local status = active and "ACTIVE" or "DISABLE"
    return string.format("%s: %s", shortName, status)
end

task.spawn(function() 
    while true do 
        task.wait(2)
        pcall(function()
            ArtifactPara:SetContent(table.concat({
                FormatArtifactStatus("Arrow Artifact", HasArtifactWorld("Arrow Artifact")),
                FormatArtifactStatus("Crescent Artifact", HasArtifactWorld("Crescent Artifact")),
                FormatArtifactStatus("Hourglass Diamond Artifact", HasArtifactWorld("Hourglass Diamond Artifact")),
                FormatArtifactStatus("Diamond Artifact", HasArtifactWorld("Diamond Artifact"))
            }, "\n"))
        end) 
    end 
end)

ArtifactSec:AddButton({ Title = "TP Arrow Artifact", Callback = function() Teleport(_G.artifactPositions["Arrow Artifact"]) end })
ArtifactSec:AddButton({ Title = "TP Hourglass Artifact", Callback = function() Teleport(_G.artifactPositions["Hourglass Diamond Artifact"]) end })
ArtifactSec:AddButton({ Title = "TP Crescent Artifact", Callback = function() Teleport(_G.artifactPositions["Crescent Artifact"]) end })
ArtifactSec:AddButton({ Title = "TP Diamond Artifact", Callback = function() Teleport(_G.artifactPositions["Diamond Artifact"]) end })

ArtifactSec:AddToggle({ Title = "Auto Artifact Quest", Default = false, Callback = function(v)
    State.autoArtifact = v
    if v then task.spawn(function()
        local artifacts = {"Arrow Artifact", "Crescent Artifact", "Hourglass Diamond Artifact", "Diamond Artifact"}
        while State.autoArtifact do
            for _, art in ipairs(artifacts) do
                if not State.autoArtifact then break end
                if HasArtifactWorld(art) then
                    Teleport(_G.artifactPositions[art])
                    task.wait(2)
                    ActivateArtifact(art)
                    task.wait(1)
                end
            end
            task.wait(2)
        end
    end) end
end })

-- Deep Sea Quest - FIXED
local DeepSeaSec = QuestTab:AddSection("Deep Sea Quest")
local DeepSeaPara = DeepSeaSec:AddParagraph({ Title = "Progress", Content = "Loading..." })

task.spawn(function() 
    while true do 
        task.wait(2)
        pcall(function() 
            DeepSeaPara:SetContent(ReadTracker("Deep Sea Tracker") or "Not found") 
        end) 
    end 
end)

DeepSeaSec:AddButton({ Title = "TP Treasure Room", Callback = function() Teleport(CFrame.new(-3601, -283, -1611)) end })
DeepSeaSec:AddButton({ Title = "TP Sisyphus", Callback = function() Teleport(CFrame.new(-3698, -135, -1008)) end })

DeepSeaSec:AddToggle({ Title = "Auto Deep Sea", Default = false, Callback = function(v)
    State.autoDeepSea = v
    if v then task.spawn(function() 
        while State.autoDeepSea do
            local tracker = ReadTracker("Deep Sea Tracker"):lower()
            local hrp = GetHRP()
            if hrp then
                if tracker:find("100%%") then
                    hrp.CFrame = CFrame.new(-3763, -135, -995) * CFrame.Angles(0, math.rad(180), 0)
                else
                    hrp.CFrame = CFrame.new(-3599, -276, -1641)
                end
            end
            task.wait(1)
        end 
    end) end
end })

-- Element Quest - FIXED
local ElementSec = QuestTab:AddSection("Element Quest")
local ElementPara = ElementSec:AddParagraph({ Title = "Progress", Content = "Loading..." })

task.spawn(function() 
    while true do 
        task.wait(2)
        pcall(function() 
            ElementPara:SetContent(ReadTracker("Element Tracker") or "Not found") 
        end) 
    end 
end)

ElementSec:AddButton({ Title = "TP Sacred Temple", Callback = function() Teleport(CFrame.new(1453, -22, -636)) end })
ElementSec:AddButton({ Title = "TP Cellar", Callback = function() Teleport(CFrame.new(2136, -91, -701)) end })
ElementSec:AddButton({ Title = "TP Transcended", Callback = function() Teleport(CFrame.new(1480, 128, -593)) end })

ElementSec:AddToggle({ Title = "Auto Element", Default = false, Callback = function(v)
    State.autoElement = v
    if v then task.spawn(function() 
        while State.autoElement do
            local tracker = ReadTracker("Element Tracker"):lower()
            local hrp = GetHRP()
            if hrp then
                if tracker:find("4.") and tracker:find("100%%") then
                    hrp.CFrame = CFrame.new(1480, 128, -593)
                    State.autoElement = false
                    Notify("Element Quest Complete!")
                elseif tracker:find("3.") and not tracker:find("100%%") then
                    hrp.CFrame = CFrame.new(2136, -91, -701)
                else
                    hrp.CFrame = CFrame.new(1453, -22, -636)
                end
            end
            task.wait(1)
        end 
    end) end
end })

-- ==================== TELEPORT TAB ====================
local TeleTab = Window:AddTab({ Name = "Teleport", Icon = "rbxassetid://18648122722" })
local TeleSec = TeleTab:AddSection("Location")
TeleSec:AddDropdown({ Title = "Select Location", Options = locationNames, Callback = function(v) State.teleportTarget = v end })
TeleSec:AddButton({ Title = "Teleport", Callback = function()
    if State.teleportTarget and Locations[State.teleportTarget] then
        Teleport(Locations[State.teleportTarget])
        Notify("Teleported to " .. State.teleportTarget)
    end
end })

local PlayerTeleSec = TeleTab:AddSection("Teleport To Player")
local PlayerTeleDrop = PlayerTeleSec:AddDropdown({ Title = "Select Player", Options = GetPlayerList(), Callback = function(v) State.trade.teleportTarget = v end })
PlayerTeleSec:AddButton({ Title = "Refresh", Callback = function() 
    -- Dropdowns require manual re-adding in this simple system, or we just ignore refresh for now
    -- Real refresh would need :SetValues() which we simulated
end })
PlayerTeleSec:AddButton({ Title = "Teleport", Callback = function()
    if State.trade.teleportTarget then
        local target = Services.Players:FindFirstChild(State.trade.teleportTarget)
        if target and target.Character then
            local tHRP = target.Character:FindFirstChild("HumanoidRootPart")
            local myHRP = GetHRP()
            if tHRP and myHRP then 
                myHRP.CFrame = tHRP.CFrame + Vector3.new(0, 3, 0)
                Notify("Teleported!") 
            end
        end
    end
end })

-- ==================== WEBHOOK TAB ====================
local WebTab = Window:AddTab({ Name = "Webhook", Icon = "rbxassetid://137601480983962" })
local WebhookSec = WebTab:AddSection("Fish Webhook")
WebhookSec:AddInput({ Title = "Webhook URL", Value = "", Callback = function(v) if v:match("discord") then _G.WebhookFlags.FishCaught.URL = v end end })
WebhookSec:AddDropdown({ Title = "Tier Filter", Multi = true, Options = {"Common","Uncommon","Rare","Epic","Legendary","Mythic","Secret"}, Callback = function(v) _G.WebhookRarities = ToSet(v) end })
WebhookSec:AddToggle({ Title = "Send Webhook", Default = false, Callback = function(v) _G.WebhookFlags.FishCaught.Enabled = v end })
WebhookSec:AddButton({ Title = "Test Webhook", Callback = function()
    local url = _G.WebhookFlags.FishCaught.URL
    if url and url ~= "" then 
        SendWebhook(url, { embeds = {{ title = "DanuHub Test", description = "Webhook working!", color = 44543 }}, username = "DanuHub" })
        Notify("Test sent!") 
    else
        Notify("No URL set")
    end
end })

-- Stats Webhook
local StatsSec = WebTab:AddSection("Stats Webhook")
StatsSec:AddInput({ Title = "Stats URL", Value = "", Callback = function(v) if v:match("discord") then _G.WebhookFlags.Stats.URL = v end end })
StatsSec:AddInput({ Title = "Delay (min)", Value = "5", Callback = function(v) _G.WebhookFlags.Stats.Delay = tonumber(v) or 5 end })
StatsSec:AddToggle({ Title = "Send Stats", Default = false, Callback = function(v)
    _G.WebhookFlags.Stats.Enabled = v
    if v then task.spawn(function() 
        while _G.WebhookFlags.Stats.Enabled do
            task.wait(_G.WebhookFlags.Stats.Delay * 60)
            pcall(function()
                local coins = Data:Get({"Coins"}) or 0
                local stats = Data:Get({"Statistics"}) or {}
                SendWebhook(_G.WebhookFlags.Stats.URL, {
                    embeds = {{ title = "Player Stats", description = string.format("Coins: %d\nFish Caught: %d", coins, stats.FishCaught or 0), color = 3447003 }},
                    username = "DanuHub Stats"
                })
            end)
        end 
    end) end
end })

-- ==================== MISC TAB ====================
local MiscTab = Window:AddTab({ Name = "Misc", Icon = "rbxassetid://6034509993" })
local MiscSec = MiscTab:AddSection("Miscellaneous")

local staffRanks = { [2]=1,[3]=1,[4]=1,[75]=1,[79]=1,[145]=1,[250]=1,[252]=1,[254]=1,[255]=1,[55]=1,[30]=1,[35]=1,[100]=1,[76]=1 }
MiscSec:AddToggle({ Title = "Anti Staff", Default = false, Callback = function(v)
    _G.AntiStaff = v
    if v then task.spawn(function() 
        while _G.AntiStaff do
            for _, p in ipairs(Services.Players:GetPlayers()) do
                if p ~= LocalPlayer and staffRanks[p:GetRankInGroup(35102746)] then
                    LocalPlayer:Kick("Staff detected!")
                    return
                end
            end
            task.wait(1)
        end 
    end) end
end })

MiscSec:AddToggle({ Title = "Delete Effects", Default = false, Callback = function(v)
    _G.DelEffects = v
    if v then task.spawn(function() 
        while _G.DelEffects do
            local cf = workspace:FindFirstChild("CosmeticFolder")
            if cf then cf:Destroy() end
            task.wait(30)
        end 
    end) end
end })

MiscSec:AddToggle({ Title = "Hide Rod", Default = false, Callback = function(v)
    _G.IrRod = v
    if v then task.spawn(function() 
        while _G.IrRod do
            local chars = workspace:FindFirstChild("Characters")
            if chars then 
                for _, c in ipairs(chars:GetChildren()) do
                    local t = c:FindFirstChild("!!!EQUIPPED_TOOL!!!")
                    if t then t:Destroy() end
                end 
            end
            task.wait(1)
        end 
    end) end
end })

MiscSec:AddButton({ Title = "Rejoin", Callback = function() Services.TeleportService:Teleport(game.PlaceId, LocalPlayer) end })
MiscSec:AddButton({ Title = "Copy Position", Callback = function()
    local hrp = GetHRP()
    if hrp and setclipboard then 
        setclipboard(string.format("%.1f, %.1f, %.1f", hrp.Position.X, hrp.Position.Y, hrp.Position.Z))
        Notify("Copied!") 
    end
end })

MiscSec:AddButton({ Title = "Disable All Features", Callback = DisableAllFeatures })

Notify("DanuHub_Luxury v2.2 Loaded!")
Notify("Press RightControl/Home to Toggle")
